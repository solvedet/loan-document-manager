<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Loan Document Processing System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4e54c8 0%, #8f94fb 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
            font-weight: 400;
        }

        .header p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .google-auth-section {
            background: #f0f8ff;
            border: 2px solid #4285f4;
            border-radius: 15px;
            padding: 20px;
            margin: 20px;
            text-align: center;
        }

        .google-auth-section.connected {
            background: #e8f5e8;
            border-color: #34a853;
        }

        .auth-button {
            background: #4285f4;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .auth-button:hover {
            background: #3367d6;
            transform: translateY(-2px);
        }

        .auth-button.connected {
            background: #34a853;
        }

        .main-content {
            padding: 30px;
        }

        .form-section {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 5px solid #4e54c8;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .form-group input, .form-group select {
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4e54c8;
            box-shadow: 0 0 0 3px rgba(78, 84, 200, 0.1);
        }

        .company-type-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .company-type-card {
            background: white;
            border: 3px solid #e2e8f0;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .company-type-card:hover {
            border-color: #4e54c8;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(78, 84, 200, 0.1);
        }

        .company-type-card.selected {
            border-color: #4e54c8;
            background: linear-gradient(135deg, #4e54c8 0%, #8f94fb 100%);
            color: white;
        }

        .workflow-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .upload-section {
            background: white;
            border-radius: 15px;
            border: 2px solid #e2e8f0;
        }

        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 13px 13px 0 0;
            font-size: 1.2rem;
            font-weight: 500;
        }

        .bulk-upload-zone {
            border: 3px dashed #cbd5e0;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin: 20px;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .bulk-upload-zone:hover, .bulk-upload-zone.dragover {
            border-color: #4e54c8;
            background: linear-gradient(135deg, rgba(78, 84, 200, 0.05) 0%, rgba(143, 148, 251, 0.05) 100%);
        }

        .bulk-upload-zone.dragover {
            border-color: #48bb78;
            background: rgba(72, 187, 120, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.7;
        }

        .upload-text {
            font-size: 1.1rem;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .upload-subtext {
            font-size: 0.9rem;
            color: #718096;
        }

        .uploaded-files {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px;
        }

        .file-item {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: grab;
            transition: all 0.3s ease;
        }

        .file-item:hover {
            border-color: #4e54c8;
            box-shadow: 0 4px 12px rgba(78, 84, 200, 0.1);
        }

        .file-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .file-item.assigned {
            opacity: 0.5;
            background: #e8f5e8;
            border-color: #48bb78;
            transform: scale(0.95);
        }

        .file-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #4e54c8 0%, #8f94fb 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .file-details {
            font-size: 0.8rem;
            color: #718096;
        }

        .ai-suggestion {
            background: linear-gradient(135deg, #48bb78 0%, #68d391 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .checklist-section {
            background: white;
            border-radius: 15px;
            border: 2px solid #e2e8f0;
        }

        .checklist-content {
            max-height: 600px;
            overflow-y: auto;
        }

        .document-category {
            border-bottom: 1px solid #e2e8f0;
        }

        .category-header {
            background: #f7fafc;
            padding: 15px 20px;
            font-weight: 600;
            color: #2d3748;
            border-bottom: 1px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .checklist-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
            min-height: 70px;
        }

        .checklist-item:hover {
            background: #f8f9ff;
        }

        .checklist-item.drop-target {
            background: rgba(72, 187, 120, 0.1);
            border: 2px dashed #48bb78;
        }

        .checklist-item:last-child {
            border-bottom: none;
        }

        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #fed7d7;
            border: 2px solid #f56565;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            color: #742a2a;
        }

        .status-indicator.completed {
            background: #c6f6d5;
            border-color: #48bb78;
            color: #22543d;
        }

        .checklist-label {
            flex: 1;
            font-weight: 500;
            color: #2d3748;
        }

        .assigned-file {
            background: rgba(72, 187, 120, 0.1);
            border: 1px solid #48bb78;
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 0.8rem;
            color: #22543d;
            font-weight: 600;
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin: 2px;
        }

        .assigned-files {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }

        .file-count {
            color: #48bb78;
            font-weight: bold;
            font-size: 0.85rem;
        }

        .remove-assignment {
            background: #f56565;
            color: white;
            border: none;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 0.6rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4e54c8 0%, #8f94fb 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(78, 84, 200, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #48bb78 0%, #68d391 100%);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(72, 187, 120, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ed8936 0%, #f6ad55 100%);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(237, 137, 54, 0.3);
        }

        .progress-summary {
            background: #f7fafc;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .progress-item {
            text-align: center;
        }

        .progress-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .progress-label {
            font-size: 0.9rem;
            color: #718096;
        }

        .uploaded { color: #4e54c8; }
        .matched { color: #48bb78; }
        .pending { color: #ed8936; }

        .email-preview {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            display: none;
        }

        .email-preview.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .email-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            white-space: pre-line;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .workflow-container {
                grid-template-columns: 1fr;
            }
        }

        .document-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .document-modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            height: 90%;
            max-height: 700px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #4e54c8 0%, #8f94fb 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            flex: 1;
            padding: 20px;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading-spinner {
            font-size: 1.2rem;
            color: #4e54c8;
        }

        .document-viewer {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 10px;
        }

        .image-viewer {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 10px;
        }

        .text-viewer {
            width: 100%;
            height: 100%;
            background: #f8f9ff;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            overflow: auto;
            white-space: pre-wrap;
        }

        .file-analysis {
            background: #e6fffa;
            border: 2px solid #4fd1c7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .analysis-header {
            font-weight: bold;
            color: #234e52;
            margin-bottom: 10px;
        }

        .detected-content {
            color: #2d3748;
            font-size: 0.9rem;
        }

        .google-drive-files {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            margin: 10px 0;
        }

        .drive-file-item {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.3s ease;
        }

        .drive-file-item:hover {
            background: #f8f9ff;
        }

        .drive-file-item:last-child {
            border-bottom: none;
        }

        .drive-file-icon {
            width: 32px;
            height: 32px;
            background: #4285f4;
            color: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .drive-file-info {
            flex: 1;
        }

        .drive-file-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 2px;
        }

        .drive-file-details {
            font-size: 0.8rem;
            color: #718096;
        }

        .drive-select-btn {
            background: #34a853;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .google-status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }

        .google-status.success {
            background: #e8f5e8;
            color: #22543d;
            border: 1px solid #68d391;
        }

        .google-status.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #f56565;
        }
    </style>
    <!-- Google APIs -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📄 Bulk Loan Document Processing System</h1>
            <p>Upload all documents → AI-powered matching → Organize & send</p>
        </div>

        <div class="main-content">
            <!-- Google Authentication Section -->
            <div class="google-auth-section" id="googleAuthSection">
                <h3 style="margin-bottom: 15px; color: #2d3748;">🔐 Google Drive Integration</h3>
                <div id="googleAuthStatus">
                    <p style="margin-bottom: 15px; color: #4a5568;">Connect your Google account to access Drive files directly</p>
                    <button class="auth-button" id="authorizeButton" onclick="handleAuthClick()">
                        🔗 Connect Google Account
                    </button>
                    <button class="auth-button" id="signoutButton" onclick="handleSignoutClick()" style="display: none; background: #ea4335;">
                        🔓 Disconnect
                    </button>
                </div>
                <div id="googleStatus" class="google-status" style="display: none;"></div>
            </div>

            <!-- Client Information Section -->
            <div class="form-section">
                <h3 style="margin-bottom: 20px; color: #2d3748;">📋 Client Information</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="customerName">Customer Name</label>
                        <input type="text" id="customerName" placeholder="Enter customer full name" value="Ameet">
                    </div>
                    <div class="form-group">
                        <label for="bankRMName">Bank RM Name</label>
                        <input type="text" id="bankRMName" placeholder="Enter bank relationship manager name" value="Rajeev">
                    </div>
                    <div class="form-group">
                        <label for="bankRMEmail">Bank RM Email</label>
                        <input type="email" id="bankRMEmail" placeholder="rm@bank.com" value="neetesh.sharma@gmail.com">
                    </div>
                    <div class="form-group">
                        <label for="solvedetRM">Solvedet RM Name</label>
                        <input type="text" id="solvedetRM" placeholder="Enter Solvedet RM name" value="Abhijit">
                    </div>
                </div>
            </div>

            <!-- Company Type Selection -->
            <div class="form-section">
                <h3 style="margin-bottom: 20px; color: #2d3748;">🏢 Company Type</h3>
                <div class="company-type-selector">
                    <div class="company-type-card" data-type="proprietorship">
                        <h4>Proprietorship</h4>
                        <p>Individual ownership</p>
                    </div>
                    <div class="company-type-card" data-type="partnership">
                        <h4>Partnership</h4>
                        <p>Multiple partners</p>
                    </div>
                    <div class="company-type-card selected" data-type="private-limited">
                        <h4>Private Limited</h4>
                        <p>Corporate entity</p>
                    </div>
                </div>
            </div>

            <!-- Progress Summary -->
            <div class="progress-summary" id="progressSummary" style="display: none;">
                <div class="progress-item">
                    <div class="progress-number uploaded" id="uploadedCount">0</div>
                    <div class="progress-label">Uploaded</div>
                </div>
                <div class="progress-item">
                    <div class="progress-number matched" id="matchedCount">0</div>
                    <div class="progress-label">Matched</div>
                </div>
                <div class="progress-item">
                    <div class="progress-number pending" id="pendingCount">0</div>
                    <div class="progress-label">Pending</div>
                </div>
            </div>

            <!-- Main Workflow -->
            <div class="workflow-container" id="workflowContainer" style="display: none;">
                <!-- Upload Section -->
                <div class="upload-section">
                    <div class="section-header">
                        📤 Bulk Document Upload
                    </div>
                    
                    <div class="bulk-upload-zone" id="uploadZone">
                        <div class="upload-icon">📁</div>
                        <div class="upload-text">Drop documents/folders here or click to browse</div>
                        <div class="upload-subtext">Supports PDF, JPG, PNG, DOC, DOCX • Entire folders supported</div>
                        <input type="file" id="fileInput" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" style="display: none;">
                        <input type="file" id="folderInput" webkitdirectory multiple style="display: none;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin: 20px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">
                            📄 Select Files
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('folderInput').click()">
                            📁 Select Folder
                        </button>
                        <button class="btn btn-primary" id="googleDriveButton" onclick="openGoogleDrivePicker()" disabled>
                            ☁️ Google Drive
                        </button>
                    </div>

                    <!-- Google Drive File Browser -->
                    <div id="googleDriveFiles" class="google-drive-files" style="display: none;">
                        <div style="padding: 15px; background: #f8f9ff; border-bottom: 2px solid #e2e8f0; font-weight: 600;">
                            📁 Google Drive Files
                        </div>
                        <div id="driveFilesList">
                            <!-- Google Drive files will appear here -->
                        </div>
                    </div>

                    <div class="uploaded-files" id="uploadedFiles">
                        <!-- Uploaded files will appear here -->
                    </div>
                </div>

                <!-- Checklist Section -->
                <div class="checklist-section">
                    <div class="section-header">
                        ✅ Document Checklist - <span id="checklistTitle">Select Company Type</span>
                    </div>
                    <div class="checklist-content" id="checklistContent">
                        <!-- Checklist will be generated here -->
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons" id="actionButtons" style="display: none;">
                <button class="btn btn-secondary" onclick="autoMatchDocuments()">
                    🤖 AI Auto-Match
                </button>
                <button class="btn btn-warning" onclick="generateLoginQuery()">
                    📧 Generate Login Query
                </button>
                <button class="btn btn-secondary" onclick="generateBankEmail()">
                    📤 Generate Bank Email
                </button>
                <button class="btn btn-primary" onclick="downloadOrganizedDocuments()">
                    📁 Organize & Download to PC
                </button>
            </div>

            <!-- Email Preview -->
            <div class="email-preview" id="emailPreview">
                <h4 id="emailTitle"></h4>
                <div class="email-content" id="emailContent"></div>
            </div>

            <!-- Document Preview Modal -->
            <div class="document-modal" id="documentModal" onclick="closeModal(event)">
                <div class="modal-content" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <h3 id="modalTitle">Document Preview</h3>
                        <button class="close-btn" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body" id="modalBody">
                        <div class="loading-spinner">Loading document...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Core Application - Simple and Clean
        let selectedCompanyType = 'private-limited';
        let uploadedFiles = new Map();
        let documentAssignments = new Map();
        let checklistItems = [];
        
        // Google Drive variables (optional)
        let googleApiAvailable = false;
        
        // FIXED: Added missing Google API configuration variables
        let API_KEY = ''; // To be configured by user if they want Google Drive
        let CLIENT_ID = ''; // To be configured by user if they want Google Drive  
        let DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        let SCOPES = 'https://www.googleapis.com/auth/drive.readonly';
        
        // FIXED: Added missing Google API state variables
        let tokenClient = null;
        let gapiInited = false;
        let gisInited = false;
        let isAuthorized = false;

        // FIXED: Added missing utility functions
        function safeExecute(callback) {
            try {
                return callback();
            } catch (error) {
                console.error('Safe execution error:', error);
                return null;
            }
        }

        function safeGetElement(id) {
            try {
                return document.getElementById(id);
            } catch (error) {
                console.error(`Error getting element ${id}:`, error);
                return null;
            }
        }

        // Document requirements for different company types
        const documentRequirements = {
            'proprietorship': {
                'Company Documents': [
                    'AY 22-23 Full Company Financials (ITR, Computation, Balance Sheet)',
                    'AY 23-24 Full Company Financials (ITR, Computation, Balance Sheet)', 
                    'AY 24-25 Full Company Financials (ITR, Computation, Balance Sheet)',
                    'All Bank Statements (1 Year - Jan 2024 to Date)',
                    'All Loan Sanction Letters (CC, Term Loan etc.)',
                    'GST Certificate',
                    'Udyam Certificate',
                    'EMI Obligation Sheet',
                    'Latest One Year GST Returns (GSTR3B)',
                    'Detail Sheet'
                ],
                'Proprietor KYC Documents': [
                    'PAN Card',
                    'Aadhar Card',
                    'Home Light Bill'
                ]
            },
            'partnership': {
                'Company Financials and Banking': [
                    'Last 3 Years Full Company Financials (ITR, Computation, Balance Sheet, Audit Report)',
                    'Latest 1 Year All Bank Statements',
                    'All Loan and CC/OD Account Sanction Letters',
                    'EMI Obligation Sheet',
                    'Latest One Year GST Returns (GSTR3B)',
                    'Detail Sheet'
                ],
                'Company KYC Documents': [
                    'Company PAN Card',
                    'Company Profile',
                    'Partnership Deed',
                    'GST Certificate',
                    'Udyam Certificate',
                    'Latest Office Electrical Bill (or Rent Agreement if rented)'
                ],
                'Partner KYC Documents': [
                    'All Partner Photographs',
                    'All Partner PAN Cards',
                    'All Partner Aadhar Cards',
                    'All Partner Residence Electricity Bills (or Rent Agreement if rented)'
                ]
            },
            'private-limited': {
                'Company Financials and Banking': [
                    'Last 3 Years Full Company Financials (ITR, Computation, Balance Sheet, Audit Report, Director Reports)',
                    'Latest 1 Year Bank Statements (Jan 2024 to Date)',
                    'All Loan Sanction Letters (CC, Term Loan etc.)',
                    'EMI Obligation Sheet',
                    'Latest One Year GST Returns (GSTR3B) (Dec 2023 to Dec 2024)',
                    'Detail Sheet'
                ],
                'Company KYC Documents': [
                    'Company PAN Card',
                    'Memorandum of Articles',
                    'Articles of Association',
                    'Certificate of Incorporation',
                    'GST Certificate',
                    'Company Profile',
                    'Udyam Certificate',
                    'Latest Office Electrical Bill (or Rent Agreement if rented)',
                    'List of Shareholders with Shareholding Pattern on Company Letterhead',
                    'List of Directors on Company Letterhead'
                ],
                'Director KYC Documents': [
                    'All Directors Photo',
                    'All Directors PAN Card',
                    'All Directors Aadhar Card',
                    'All Directors Home Light Bill (or Rent Agreement if rented)'
                ]
            }
        };

        // AI document type detection patterns
        const documentPatterns = {
            'pan': /pan|permanent.*account/i,
            'aadhar': /aadhar|aadhaar|uid/i,
            'bank': /bank.*statement|statement.*bank|account.*statement/i,
            'gst': /gst|goods.*service.*tax|gstin/i,
            'itr': /itr|income.*tax.*return|return.*income/i,
            'balance': /balance.*sheet|financial.*statement/i,
            'audit': /audit.*report|auditor.*report/i,
            'udyam': /udyam|msme|ssi/i,
            'electricity': /electricity|electric.*bill|light.*bill/i,
            'incorporation': /incorporation|certificate.*incorporation/i,
            'moa': /memorandum|articles.*association|moa|aoa/i,
            'partnership': /partnership.*deed|deed.*partnership/i,
            'loan': /loan.*sanction|sanction.*letter|cc.*sanction|od.*sanction/i,
            'emi': /emi.*obligation|obligation.*sheet|emi.*sheet/i,
            'director': /director.*list|list.*director/i,
            'shareholder': /shareholder|shareholding.*pattern/i
        };

        // Google Drive Integration Functions (Optional Feature)
        function gapiLoaded() {
            try {
                if (typeof gapi === 'undefined') {
                    console.warn('Google API not available');
                    disableGoogleDriveIntegration();
                    return;
                }
                gapi.load('client', initializeGapiClient);
            } catch (error) {
                console.warn('Error loading GAPI:', error);
                disableGoogleDriveIntegration();
            }
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [DISCOVERY_DOC],
                });
                gapiInited = true;
                googleApiAvailable = true;
                maybeEnableButtons();
            } catch (error) {
                console.warn('Error initializing GAPI client:', error);
                disableGoogleDriveIntegration();
            }
        }

        function gisLoaded() {
            try {
                if (typeof google === 'undefined') {
                    console.warn('Google Identity not available');
                    disableGoogleDriveIntegration();
                    return;
                }
                
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: (response) => {
                        if (response.error) {
                            console.error('OAuth error:', response.error);
                            showGoogleStatus('Authentication failed. Please try again.', 'error');
                            return;
                        }
                        isAuthorized = true;
                        updateAuthUI();
                        showGoogleStatus('Successfully connected to Google Drive!', 'success');
                    }
                });
                gisInited = true;
                googleApiAvailable = true;
                maybeEnableButtons();
            } catch (error) {
                console.warn('Error initializing GIS:', error);
                disableGoogleDriveIntegration();
            }
        }

        function disableGoogleDriveIntegration() {
            googleApiAvailable = false;
            const googleDriveButton = safeGetElement('googleDriveButton');
            const googleAuthSection = safeGetElement('googleAuthSection');
            
            if (googleDriveButton) {
                googleDriveButton.disabled = true;
                googleDriveButton.innerHTML = '☁️ Google Drive (Unavailable)';
                googleDriveButton.title = 'Google Drive integration is not available';
            }
            
            if (googleAuthSection) {
                googleAuthSection.style.display = 'none';
            }
            
            console.info('Google Drive integration disabled - app will work without it');
        }

        function maybeEnableButtons() {
            if (googleApiAvailable && gapiInited && gisInited) {
                const googleDriveButton = safeGetElement('googleDriveButton');
                if (googleDriveButton) {
                    googleDriveButton.disabled = false;
                    googleDriveButton.innerHTML = '☁️ Google Drive';
                }
            }
        }

        function handleAuthClick() {
            if (!googleApiAvailable) {
                alert('Google Drive integration is not available. Please use local file upload instead.');
                return;
            }
            
            if (!tokenClient) {
                showGoogleStatus('Google authentication not initialized.', 'error');
                return;
            }
            
            try {
                if (gapi.client.getToken() === null) {
                    tokenClient.requestAccessToken({prompt: 'consent'});
                } else {
                    tokenClient.requestAccessToken({prompt: ''});
                }
            } catch (error) {
                console.error('Error during authentication:', error);
                showGoogleStatus('Authentication failed. Please try again.', 'error');
            }
        }

        function handleSignoutClick() {
            if (!googleApiAvailable) return;
            
            try {
                const token = gapi.client.getToken();
                if (token !== null) {
                    google.accounts.oauth2.revoke(token.access_token);
                    gapi.client.setToken('');
                    isAuthorized = false;
                    updateAuthUI();
                    showGoogleStatus('Disconnected from Google Drive.', 'success');
                    const googleDriveFiles = safeGetElement('googleDriveFiles');
                    if (googleDriveFiles) {
                        googleDriveFiles.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error during signout:', error);
                showGoogleStatus('Error disconnecting from Google Drive.', 'error');
            }
        }

        function updateAuthUI() {
            const authSection = safeGetElement('googleAuthSection');
            const authorizeButton = safeGetElement('authorizeButton');
            const signoutButton = safeGetElement('signoutButton');
            
            if (isAuthorized) {
                if (authSection) authSection.classList.add('connected');
                if (authorizeButton) authorizeButton.style.display = 'none';
                if (signoutButton) {
                    signoutButton.style.display = 'inline-flex';
                    signoutButton.classList.add('connected');
                }
            } else {
                if (authSection) authSection.classList.remove('connected');
                if (authorizeButton) authorizeButton.style.display = 'inline-flex';
                if (signoutButton) signoutButton.style.display = 'none';
            }
        }

        function showGoogleStatus(message, type) {
            const statusDiv = safeGetElement('googleStatus');
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `google-status ${type}`;
                statusDiv.style.display = 'block';
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        function openGoogleDrivePicker() {
            safeExecute(async () => {
                if (!googleApiAvailable) {
                    alert('Google Drive integration is not available.\n\nPlease use:\n• Select Files button\n• Select Folder button\n• Drag & drop files directly');
                    return;
                }
                
                if (!isAuthorized) {
                    alert('Please connect your Google account first.');
                    return;
                }

                const response = await gapi.client.drive.files.list({
                    pageSize: 100,
                    fields: 'nextPageToken, files(id, name, mimeType, size, modifiedTime, parents)',
                    q: "(mimeType='application/pdf' or mimeType contains 'image/' or mimeType contains 'document' or mimeType='application/vnd.google-apps.folder') and trashed=false"
                });

                const files = response.result.files;
                if (!files || files.length === 0) {
                    showGoogleStatus('No documents found in your Google Drive.', 'error');
                    return;
                }

                displayGoogleDriveFiles(files);
            });
        }

        function displayGoogleDriveFiles(files) {
            safeExecute(() => {
                const driveFilesContainer = safeGetElement('googleDriveFiles');
                const driveFilesList = safeGetElement('driveFilesList');
                
                if (!driveFilesList) return;
                
                driveFilesList.innerHTML = '';
                
                files.forEach(file => {
                    const fileElement = document.createElement('div');
                    fileElement.className = 'drive-file-item';
                    
                    const mimeType = file.mimeType || '';
                    const isFolder = mimeType === 'application/vnd.google-apps.folder';
                    const fileExtension = isFolder ? 'DIR' : getFileExtension(file.name, mimeType);
                    const fileSize = file.size ? formatFileSize(file.size) : (isFolder ? 'Folder' : 'Unknown size');
                    
                    fileElement.innerHTML = `
                        <div class="drive-file-icon" style="${isFolder ? 'background: #ffa500;' : ''}">${fileExtension}</div>
                        <div class="drive-file-info">
                            <div class="drive-file-name">${file.name}</div>
                            <div class="drive-file-details">${fileSize} • ${new Date(file.modifiedTime).toLocaleDateString()}</div>
                        </div>
                        <button class="drive-select-btn" onclick="${isFolder ? `importGoogleDriveFolder('${file.id}', '${file.name}')` : `downloadGoogleDriveFile('${file.id}', '${file.name}', '${mimeType}')`}">
                            ${isFolder ? 'Import Folder' : 'Import'}
                        </button>
                    `;
                    
                    driveFilesList.appendChild(fileElement);
                });
                
                if (driveFilesContainer) {
                    driveFilesContainer.style.display = 'block';
                }
            });
        }

        function downloadGoogleDriveFile(fileId, fileName, mimeType) {
            safeExecute(async () => {
                showGoogleStatus('Importing file from Google Drive...', 'success');
                
                let downloadUrl;
                let finalMimeType = mimeType;
                
                if (mimeType === 'application/vnd.google-apps.document') {
                    downloadUrl = `https://www.googleapis.com/drive/v3/files/${fileId}/export?mimeType=application/pdf`;
                    fileName = fileName.replace(/\.[^/.]+$/, "") + '.pdf';
                    finalMimeType = 'application/pdf';
                } else if (mimeType === 'application/vnd.google-apps.spreadsheet') {
                    downloadUrl = `https://www.googleapis.com/drive/v3/files/${fileId}/export?mimeType=application/pdf`;
                    fileName = fileName.replace(/\.[^/.]+$/, "") + '.pdf';
                    finalMimeType = 'application/pdf';
                } else {
                    downloadUrl = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;
                }
                
                const response = await gapi.client.request({
                    path: downloadUrl,
                    method: 'GET'
                });
                
                const blob = new Blob([response.body], { type: finalMimeType });
                const file = new File([blob], fileName, { type: finalMimeType });
                
                const newFileId = `gdrive-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                const aiSuggestion = await analyzeDocumentContent(file);
                
                uploadedFiles.set(newFileId, {
                    file: file,
                    name: fileName,
                    size: blob.size,
                    type: finalMimeType,
                    aiSuggestion: aiSuggestion,
                    assigned: false,
                    source: 'google-drive'
                });
                
                const fileElement = createFileElement(newFileId, file, aiSuggestion);
                const fileInfo = fileElement.querySelector('.file-info');
                if (fileInfo) {
                    fileInfo.innerHTML += '<br><small style="color: #4285f4;">☁️ From Google Drive</small>';
                }
                
                const uploadedFilesContainer = safeGetElement('uploadedFiles');
                if (uploadedFilesContainer) {
                    uploadedFilesContainer.appendChild(fileElement);
                }
                
                updateProgress();
                showGoogleStatus(`Successfully imported ${fileName}`, 'success');
            });
        }

        function importGoogleDriveFolder(folderId, folderName) {
            safeExecute(async () => {
                showGoogleStatus(`Importing folder "${folderName}" from Google Drive...`, 'success');
                
                const response = await gapi.client.drive.files.list({
                    pageSize: 100,
                    fields: 'files(id, name, mimeType, size, modifiedTime)',
                    q: `'${folderId}' in parents and trashed=false and (mimeType='application/pdf' or mimeType contains 'image/' or mimeType contains 'document')`
                });

                const files = response.result.files;
                if (!files || files.length === 0) {
                    showGoogleStatus(`No documents found in folder "${folderName}".`, 'error');
                    return;
                }

                let importedCount = 0;
                for (const file of files) {
                    try {
                        await downloadGoogleDriveFile(file.id, file.name, file.mimeType);
                        importedCount++;
                        await new Promise(resolve => setTimeout(resolve, 200));
                    } catch (error) {
                        console.error(`Error importing file ${file.name}:`, error);
                    }
                }

                showGoogleStatus(`Successfully imported ${importedCount} files from folder "${folderName}"`, 'success');
            });
        }

        function getFileExtension(fileName, mimeType) {
            if (mimeType) {
                if (mimeType.includes('pdf')) return 'PDF';
                if (mimeType.includes('image')) return 'IMG';
                if (mimeType.includes('document')) return 'DOC';
                if (mimeType.includes('spreadsheet')) return 'XLS';
            }
            const ext = fileName.split('.').pop();
            return ext ? ext.toUpperCase().substr(0, 3) : 'FILE';
        }

        function formatFileSize(bytes) {
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            if (bytes === 0) return '0 Bytes';
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing Loan Document Management System...');
            
            try {
                setupCompanyTypeSelection();
                setupDragAndDrop();
                generateChecklist(); // Start with private-limited selected
                
                console.log('✅ Core functionality initialized');
                
                // Google Drive integration is optional - don't block app startup
                setTimeout(() => {
                    if (!googleApiAvailable) {
                        console.info('ℹ️ Google Drive integration not available - app running in local mode');
                        disableGoogleDriveIntegration();
                    }
                }, 3000); // Give APIs 3 seconds to load
                
            } catch (error) {
                console.error('Error initializing app:', error);
                alert('There was an error starting the application. Please refresh the page.');
            }
        });

        function setupCompanyTypeSelection() {
            const companyCards = document.querySelectorAll('.company-type-card');
            companyCards.forEach(card => {
                card.addEventListener('click', function() {
                    companyCards.forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedCompanyType = this.dataset.type;
                    generateChecklist();
                });
            });
        }

        function setupDragAndDrop() {
            const uploadZone = safeGetElement('uploadZone');
            const fileInput = safeGetElement('fileInput');
            const folderInput = safeGetElement('folderInput');

            if (uploadZone && fileInput) {
                uploadZone.addEventListener('click', () => fileInput.click());
                
                uploadZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadZone.classList.add('dragover');
                });

                uploadZone.addEventListener('dragleave', () => {
                    uploadZone.classList.remove('dragover');
                });

                uploadZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadZone.classList.remove('dragover');
                    handleFiles(e.dataTransfer.files);
                });

                fileInput.addEventListener('change', (e) => {
                    handleFiles(e.target.files);
                });
            }

            if (folderInput) {
                folderInput.addEventListener('change', (e) => {
                    handleFiles(e.target.files);
                });
            }
        }

        function generateChecklist() {
            const requirements = documentRequirements[selectedCompanyType];
            const checklistContent = safeGetElement('checklistContent');
            const checklistTitle = safeGetElement('checklistTitle');
            const workflowContainer = safeGetElement('workflowContainer');
            const progressSummary = safeGetElement('progressSummary');
            const actionButtons = safeGetElement('actionButtons');
            
            // Show containers
            if (workflowContainer) workflowContainer.style.display = 'grid';
            if (progressSummary) progressSummary.style.display = 'grid';
            if (actionButtons) actionButtons.style.display = 'grid';
            
            // Update title
            if (checklistTitle) {
                checklistTitle.textContent = selectedCompanyType.replace(/-/g, ' ').toUpperCase();
            }
            
            // Clear previous content
            if (checklistContent) {
                checklistContent.innerHTML = '';
            }
            
            // Reset document assignments - ensure it's properly initialized
            documentAssignments = new Map();
            checklistItems = [];
            
            // Generate checklist HTML
            let htmlContent = '';
            let itemIndex = 0;
            
            Object.keys(requirements).forEach(category => {
                htmlContent += `<div class="document-category">`;
                htmlContent += `<div class="category-header">${category}</div>`;
                
                requirements[category].forEach(document => {
                    const itemId = `checklist-${itemIndex}`;
                    checklistItems.push({
                        id: itemId,
                        category: category,
                        document: document,
                        assigned: false
                    });
                    
                    htmlContent += `
                        <div class="checklist-item" data-item-id="${itemId}" ondrop="handleDrop(event)" ondragover="allowDrop(event)">
                            <div class="status-indicator" id="status-${itemId}">✗</div>
                            <div class="checklist-label">${document} <span class="file-count" id="count-${itemId}" style="color: #48bb78; font-weight: bold;">(0 files)</span></div>
                            <div class="assigned-files" id="assigned-${itemId}" style="display: none; flex-wrap: wrap; gap: 5px; margin-top: 8px;">
                                <!-- Multiple assigned files will appear here -->
                            </div>
                        </div>
                    `;
                    itemIndex++;
                });
                
                htmlContent += `</div>`;
            });
            
            if (checklistContent) {
                checklistContent.innerHTML = htmlContent;
            }
            updateProgress();
        }

        function handleFiles(files) {
            const uploadedFilesContainer = safeGetElement('uploadedFiles');
            
            Array.from(files).forEach(async (file) => {
                const fileId = `file-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                
                // Enhanced AI suggestion based on content analysis
                const aiSuggestion = await analyzeDocumentContent(file);
                
                uploadedFiles.set(fileId, {
                    file: file,
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    aiSuggestion: aiSuggestion,
                    assigned: false,
                    webkitRelativePath: file.webkitRelativePath || '' // For folder uploads
                });
                
                const fileElement = createFileElement(fileId, file, aiSuggestion);
                if (uploadedFilesContainer) {
                    uploadedFilesContainer.appendChild(fileElement);
                }
            });
            
            updateProgress();
        }

        async function analyzeDocumentContent(file) {
            try {
                // First check filename patterns
                const filenameMatch = detectDocumentType(file.name);
                if (filenameMatch) return filenameMatch;

                // For images, simulate OCR content analysis
                if (file.type.startsWith('image/')) {
                    return await simulateImageOCR(file);
                }
                
                // For PDFs, simulate text extraction
                if (file.type === 'application/pdf') {
                    return await simulatePDFTextExtraction(file);
                }
                
                return null;
            } catch (error) {
                console.error('Error analyzing document:', error);
                return detectDocumentType(file.name); // Fallback to filename analysis
            }
        }

        async function simulateImageOCR(file) {
            // Simulate OCR analysis based on common document characteristics
            const fileName = file.name.toLowerCase();
            
            // Simulate reading image content patterns
            if (fileName.includes('pan') || fileName.includes('card')) return 'PAN Card';
            if (fileName.includes('aadhar') || fileName.includes('aadhaar')) return 'Aadhar Card';
            if (fileName.includes('bank') || fileName.includes('statement')) return 'Bank Statement';
            if (fileName.includes('gst')) return 'GST Certificate';
            if (fileName.includes('bill') || fileName.includes('electricity')) return 'Electricity Bill';
            
            // For demo purposes, randomly assign some common document types
            const commonTypes = ['PAN Card', 'Aadhar Card', 'Bank Statement', 'GST Certificate'];
            return commonTypes[Math.floor(Math.random() * commonTypes.length)];
        }

        async function simulatePDFTextExtraction(file) {
            // Simulate PDF text extraction
            const fileName = file.name.toLowerCase();
            
            if (fileName.includes('itr') || fileName.includes('return')) return 'ITR Document';
            if (fileName.includes('balance') || fileName.includes('sheet')) return 'Balance Sheet';
            if (fileName.includes('audit')) return 'Audit Report';
            if (fileName.includes('incorporation')) return 'Incorporation Certificate';
            if (fileName.includes('moa') || fileName.includes('articles')) return 'MOA/AOA';
            
            return 'Financial Document';
        }

        function createFileElement(fileId, file, aiSuggestion) {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'file-item';
            fileDiv.draggable = true;
            fileDiv.dataset.fileId = fileId;
            
            const fileExtension = file.name.split('.').pop().toUpperCase();
            const fileSize = (file.size / 1024 / 1024).toFixed(2);
            
            fileDiv.innerHTML = `
                <div class="file-icon">${fileExtension}</div>
                <div class="file-info">
                    <div class="file-name">${file.name}</div>
                    <div class="file-details">${fileSize} MB • ${file.type || 'Unknown type'}</div>
                </div>
                ${aiSuggestion ? `<div class="ai-suggestion">🤖 ${aiSuggestion}</div>` : ''}
                <button class="btn btn-primary" style="padding: 5px 10px; font-size: 0.8rem;" onclick="previewDocument('${fileId}')">
                    👁️ Preview
                </button>
            `;
            
            fileDiv.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', fileId);
                fileDiv.classList.add('dragging');
            });
            
            fileDiv.addEventListener('dragend', () => {
                fileDiv.classList.remove('dragging');
            });
            
            return fileDiv;
        }

        function detectDocumentType(filename) {
            const lowerName = filename.toLowerCase();
            
            for (const [type, pattern] of Object.entries(documentPatterns)) {
                if (pattern.test(lowerName)) {
                    switch(type) {
                        case 'pan': return 'PAN Card';
                        case 'aadhar': return 'Aadhar Card';
                        case 'bank': return 'Bank Statement';
                        case 'gst': return 'GST Certificate';
                        case 'itr': return 'ITR Document';
                        case 'balance': return 'Balance Sheet';
                        case 'audit': return 'Audit Report';
                        case 'udyam': return 'Udyam Certificate';
                        case 'electricity': return 'Electricity Bill';
                        case 'incorporation': return 'Incorporation Certificate';
                        case 'moa': return 'MOA/AOA';
                        case 'partnership': return 'Partnership Deed';
                        case 'loan': return 'Loan Sanction Letter';
                        case 'emi': return 'EMI Obligation Sheet';
                        case 'director': return 'Directors List';
                        case 'shareholder': return 'Shareholders List';
                    }
                }
            }
            return null;
        }

        function allowDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drop-target');
        }

        function handleDrop(event) {
            event.preventDefault();
            const fileId = event.dataTransfer.getData('text/plain');
            const itemId = event.currentTarget.dataset.itemId;
            
            event.currentTarget.classList.remove('drop-target');
            assignFileToChecklist(fileId, itemId);
        }

        function assignFileToChecklist(fileId, itemId) {
            const file = uploadedFiles.get(fileId);
            const item = checklistItems.find(item => item.id === itemId);
            
            if (!file || !item || file.assigned) return;
            
            // Initialize assignment array if it doesn't exist
            if (!documentAssignments.has(itemId)) {
                documentAssignments.set(itemId, []);
            }
            
            // Add file to assignment array
            const assignedFiles = documentAssignments.get(itemId);
            assignedFiles.push(fileId);
            
            // Mark file as assigned
            file.assigned = true;
            file.assignedTo = itemId;
            item.assigned = true;
            
            // Update UI
            const statusIndicator = safeGetElement(`status-${itemId}`);
            const assignedFilesDiv = safeGetElement(`assigned-${itemId}`);
            const fileCountSpan = safeGetElement(`count-${itemId}`);
            
            if (statusIndicator) {
                statusIndicator.textContent = '✓';
                statusIndicator.classList.add('completed');
            }
            
            if (assignedFilesDiv) {
                // Create file tag
                const fileTag = document.createElement('div');
                fileTag.className = 'assigned-file';
                fileTag.id = `file-tag-${fileId}`;
                fileTag.innerHTML = `
                    <span class="file-name">${file.name}</span>
                    <button class="remove-assignment" onclick="removeSingleAssignment('${itemId}', '${fileId}')">×</button>
                `;
                
                assignedFilesDiv.appendChild(fileTag);
                assignedFilesDiv.style.display = 'flex';
            }
            
            // Update file count
            if (fileCountSpan) {
                fileCountSpan.textContent = `(${assignedFiles.length} files)`;
            }
            
            // Hide the file from uploaded files section
            const fileElement = document.querySelector(`[data-file-id="${fileId}"]`);
            if (fileElement) {
                fileElement.classList.add('assigned');
                fileElement.style.display = 'none';
            }
            
            updateProgress();
        }

        function removeSingleAssignment(itemId, fileId) {
            const assignedFiles = documentAssignments.get(itemId);
            if (!assignedFiles) return;
            
            // Remove fileId from the array
            const fileIndex = assignedFiles.indexOf(fileId);
            if (fileIndex > -1) {
                assignedFiles.splice(fileIndex, 1);
            }
            
            const file = uploadedFiles.get(fileId);
            const item = checklistItems.find(item => item.id === itemId);
            
            if (file) {
                file.assigned = false;
                file.assignedTo = null;
            }
            
            // Update UI
            const fileTag = safeGetElement(`file-tag-${fileId}`);
            if (fileTag) {
                fileTag.remove();
            }
            
            const fileCountSpan = safeGetElement(`count-${itemId}`);
            const assignedFilesDiv = safeGetElement(`assigned-${itemId}`);
            
            // Update file count
            if (fileCountSpan) {
                fileCountSpan.textContent = `(${assignedFiles.length} files)`;
            }
            
            // If no files left, update status
            if (assignedFiles.length === 0) {
                const statusIndicator = safeGetElement(`status-${itemId}`);
                if (statusIndicator) {
                    statusIndicator.textContent = '✗';
                    statusIndicator.classList.remove('completed');
                }
                if (assignedFilesDiv) {
                    assignedFilesDiv.style.display = 'none';
                }
                if (item) {
                    item.assigned = false;
                }
                documentAssignments.delete(itemId);
            }
            
            // Show the file back in uploaded files section
            const fileElement = document.querySelector(`[data-file-id="${fileId}"]`);
            if (fileElement) {
                fileElement.classList.remove('assigned');
                fileElement.style.display = 'flex';
            }
            
            updateProgress();
        }

        function removeAssignment(itemId) {
            // Remove all assignments for this item (for backwards compatibility)
            const assignedFiles = documentAssignments.get(itemId);
            if (!assignedFiles || assignedFiles.length === 0) return;
            
            // Remove all files from this checklist item
            const filesToRemove = [...assignedFiles]; // Create a copy to avoid modification during iteration
            filesToRemove.forEach(fileId => {
                removeSingleAssignment(itemId, fileId);
            });
        }

        function updateProgress() {
            try {
                const uploadedCount = uploadedFiles.size;
                let totalMatchedFiles = 0;
                
                // Count total matched files across all checklist items
                for (const [itemId, fileIds] of documentAssignments.entries()) {
                    if (Array.isArray(fileIds)) {
                        totalMatchedFiles += fileIds.length;
                    }
                }
                
                const totalRequired = checklistItems.length;
                const pendingCount = checklistItems.filter(item => !item.assigned).length;
                
                const uploadedCountEl = safeGetElement('uploadedCount');
                const matchedCountEl = safeGetElement('matchedCount');
                const pendingCountEl = safeGetElement('pendingCount');
                
                if (uploadedCountEl) uploadedCountEl.textContent = uploadedCount;
                if (matchedCountEl) matchedCountEl.textContent = totalMatchedFiles;
                if (pendingCountEl) pendingCountEl.textContent = pendingCount;
            } catch (error) {
                console.warn('Error updating progress:', error);
            }
        }

        function autoMatchDocuments() {
            let matchCount = 0;
            const matchedPairs = [];
            
            console.log('Starting AI Auto-Match...');
            console.log('Available files:', Array.from(uploadedFiles.keys()));
            console.log('Available checklist items:', checklistItems.map(item => item.document));
            
            for (const [fileId, file] of uploadedFiles.entries()) {
                if (file.assigned || !file.aiSuggestion) {
                    console.log(`Skipping ${file.name}: assigned=${file.assigned}, suggestion=${file.aiSuggestion}`);
                    continue;
                }
                
                // Find best matching checklist item using multiple strategies
                let bestMatch = null;
                
                // Strategy 1: Exact AI suggestion match
                bestMatch = checklistItems.find(item => 
                    !item.assigned && 
                    item.document.toLowerCase().includes(file.aiSuggestion.toLowerCase())
                );
                
                // Strategy 2: Keyword matching
                if (!bestMatch) {
                    const suggestionKeywords = file.aiSuggestion.toLowerCase().split(' ');
                    bestMatch = checklistItems.find(item => 
                        !item.assigned && 
                        suggestionKeywords.some(keyword => 
                            item.document.toLowerCase().includes(keyword)
                        )
                    );
                }
                
                // Strategy 3: Enhanced pattern matching
                if (!bestMatch) {
                    const suggestion = file.aiSuggestion.toLowerCase();
                    bestMatch = checklistItems.find(item => {
                        if (item.assigned) return false;
                        
                        const itemText = item.document.toLowerCase();
                        
                        // Specific mappings
                        if (suggestion.includes('pan') && itemText.includes('pan')) return true;
                        if (suggestion.includes('aadhar') && itemText.includes('aadhar')) return true;
                        if (suggestion.includes('bank') && itemText.includes('bank')) return true;
                        if (suggestion.includes('gst') && itemText.includes('gst')) return true;
                        if (suggestion.includes('itr') && itemText.includes('itr')) return true;
                        if (suggestion.includes('balance') && itemText.includes('balance')) return true;
                        if (suggestion.includes('audit') && itemText.includes('audit')) return true;
                        if (suggestion.includes('udyam') && itemText.includes('udyam')) return true;
                        if (suggestion.includes('electricity') && (itemText.includes('electric') || itemText.includes('light'))) return true;
                        if (suggestion.includes('incorporation') && itemText.includes('incorporation')) return true;
                        if (suggestion.includes('moa') && (itemText.includes('memorandum') || itemText.includes('articles'))) return true;
                        if (suggestion.includes('partnership') && itemText.includes('partnership')) return true;
                        if (suggestion.includes('loan') && itemText.includes('loan')) return true;
                        if (suggestion.includes('emi') && itemText.includes('emi')) return true;
                        if (suggestion.includes('director') && itemText.includes('director')) return true;
                        if (suggestion.includes('shareholder') && itemText.includes('shareholder')) return true;
                        
                        return false;
                    });
                }
                
                if (bestMatch) {
                    console.log(`Matching ${file.name} (${file.aiSuggestion}) -> ${bestMatch.document}`);
                    assignFileToChecklist(fileId, bestMatch.id);
                    matchedPairs.push({ file: file.name, document: bestMatch.document });
                    matchCount++;
                } else {
                    console.log(`No match found for ${file.name} (${file.aiSuggestion})`);
                }
            }
            
            // Show detailed results
            let resultMessage = `🤖 AI Auto-Match Complete!\n\n`;
            resultMessage += `✅ Successfully matched ${matchCount} documents:\n\n`;
            
            if (matchedPairs.length > 0) {
                matchedPairs.forEach((pair, index) => {
                    resultMessage += `${index + 1}. ${pair.file}\n   → ${pair.document}\n\n`;
                });
            } else {
                resultMessage += 'No automatic matches found.\n';
                resultMessage += 'Try manually dragging files to checklist items.\n\n';
            }
            
            resultMessage += `📋 Please review and adjust matches as needed.`;
            
            alert(resultMessage);
        }

        function generateLoginQuery() {
            const customerName = safeGetElement('customerName')?.value || 'Customer';
            const missingDocs = checklistItems.filter(item => !item.assigned).map(item => item.document);
            
            if (missingDocs.length === 0) {
                alert('All documents are assigned! No login query needed.');
                return;
            }
            
            const emailContent = `Subject: Required Documents - ${customerName} Loan Application

Dear ${customerName},

We have reviewed your loan application and require the following additional documents to proceed:

${missingDocs.map((doc, index) => `${index + 1}. ${doc}`).join('\n')}

Please submit these documents at your earliest convenience to avoid any delays in processing your loan application.

If you have any questions or need clarification about any of these documents, please feel free to contact us.

Thank you for your cooperation.

Best regards,
Loan Processing Team`;
            
            showEmailPreview('Login Query Email', emailContent);
        }

        function generateBankEmail() {
            const customerName = safeGetElement('customerName')?.value || 'Customer';
            const bankRMName = safeGetElement('bankRMName')?.value || 'Bank RM';
            const bankRMEmail = safeGetElement('bankRMEmail')?.value || 'rm@bank.com';
            
            const assignedDocs = [];
            for (const [itemId, fileIds] of documentAssignments.entries()) {
                const item = checklistItems.find(i => i.id === itemId);
                if (item && fileIds.length > 0) {
                    const fileNames = fileIds.map(fileId => {
                        const file = uploadedFiles.get(fileId);
                        return file ? file.name : 'Unknown file';
                    });
                    assignedDocs.push(`${item.document} (${fileNames.join(', ')})`);
                }
            }
            
            if (assignedDocs.length === 0) {
                alert('No documents matched yet!');
                return;
            }
            
            const solvedetRM = safeGetElement('solvedetRM')?.value || 'Solvedet RM';
            
            const emailContent = `To: ${bankRMEmail}
Subject: Loan Documents - ${customerName}

Dear ${bankRMName},

Please find attached the loan application documents for ${customerName}.

Documents included:
${assignedDocs.map((doc, index) => `${index + 1}. ${doc}`).join('\n')}

All documents have been verified and are ready for your review.

Should you require any additional information, please let us know.

Best regards,
${solvedetRM}`;
            
            showEmailPreview('Bank RM Email', emailContent);
        }

        function showEmailPreview(title, content) {
            const emailPreview = safeGetElement('emailPreview');
            const emailTitle = safeGetElement('emailTitle');
            const emailContent = safeGetElement('emailContent');
            
            if (emailTitle) emailTitle.textContent = title;
            if (emailContent) emailContent.textContent = content;
            if (emailPreview) {
                emailPreview.classList.add('show');
                emailPreview.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function downloadOrganizedDocuments() {
            if (documentAssignments.size === 0) {
                alert('❌ No documents matched yet!\n\nPlease:\n1. Upload some documents\n2. Use AI Auto-Match or manually assign\n3. Try again');
                return;
            }
            
            const customerName = safeGetElement('customerName')?.value || 'Customer';
            
            try {
                console.log('Starting document organization...');
                console.log('Document assignments:', documentAssignments);
                
                // Group documents by category for folder organization
                const documentsByCategory = new Map();
                const renamedFiles = [];
                
                for (const [itemId, fileIds] of documentAssignments.entries()) {
                    const item = checklistItems.find(i => i.id === itemId);
                    
                    if (item && fileIds.length > 0) {
                        const category = item.category.replace(/[^a-zA-Z0-9\s]/g, '').replace(/\s+/g, '_');
                        if (!documentsByCategory.has(category)) {
                            documentsByCategory.set(category, []);
                        }
                        
                        fileIds.forEach((fileId, index) => {
                            const file = uploadedFiles.get(fileId);
                            if (file) {
                                // Generate new filename
                                const fileExtension = file.name.split('.').pop().toLowerCase();
                                const documentType = item.document.toLowerCase()
                                    .replace(/[^a-z0-9\s]/g, '')
                                    .replace(/\s+/g, '_')
                                    .replace(/_{2,}/g, '_')
                                    .substring(0, 40);
                                const sanitizedCustomer = customerName.replace(/[^a-zA-Z0-9]/g, '_');
                                const fileNumber = fileIds.length > 1 ? `_${index + 1}` : '';
                                const newFileName = `${documentType}_${sanitizedCustomer}${fileNumber}.${fileExtension}`;
                                
                                documentsByCategory.get(category).push({
                                    originalName: file.name,
                                    newName: newFileName,
                                    document: item.document,
                                    path: file.webkitRelativePath || file.name,
                                    fileId: fileId,
                                    itemId: itemId
                                });
                                
                                renamedFiles.push({
                                    originalFile: file.file,
                                    newName: newFileName,
                                    category: category
                                });
                            }
                        });
                    }
                }
                
                console.log('Documents by category:', documentsByCategory);
                
                // Download actual files with organized structure
                renamedFiles.forEach((fileData, index) => {
                    setTimeout(() => {
                        const blob = new Blob([fileData.originalFile], { type: fileData.originalFile.type });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${fileData.category}_${fileData.newName}`;
                        
                        // Ensure the link is added to DOM for download
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        
                        // Clean up the URL
                        setTimeout(() => URL.revokeObjectURL(url), 1000);
                    }, index * 500); // Stagger downloads to avoid browser blocking
                });
                
                // Create comprehensive download summary
                let summary = `LOAN DOCUMENT ORGANIZATION PLAN\n`;
                summary += `==========================================\n`;
                summary += `Customer: ${customerName}\n`;
                summary += `Generated: ${new Date().toLocaleString()}\n`;
                summary += `Company Type: ${selectedCompanyType.replace(/-/g, ' ').toUpperCase()}\n`;
                summary += `Total Documents Processed: ${documentAssignments.size}\n`;
                summary += `==========================================\n\n`;
                
                summary += `📁 RECOMMENDED FOLDER STRUCTURE:\n`;
                summary += `\n${customerName}_Loan_Documents/\n`;
                
                if (documentsByCategory.size > 0) {
                    documentsByCategory.forEach((files, category) => {
                        summary += `├── ${category}/\n`;
                        files.forEach((file, index) => {
                            const isLast = index === files.length - 1;
                            const prefix = isLast ? '└──' : '├──';
                            summary += `│   ${prefix} ${file.newName}\n`;
                            summary += `│       📄 Original: ${file.originalName}\n`;
                            summary += `│       📋 Document: ${file.document}\n`;
                        });
                        summary += `│\n`;
                    });
                } else {
                    summary += `└── (No documents organized yet)\n\n`;
                }
                
                // File renaming instructions
                summary += `\n🔄 FILE ORGANIZATION INSTRUCTIONS:\n`;
                summary += `=====================================\n`;
                summary += `All matched files have been downloaded with organized names.\n`;
                summary += `Create the folder structure above and move files accordingly.\n\n`;
                
                renamedFiles.forEach((file, index) => {
                    summary += `${index + 1}. Downloaded: ${file.category}_${file.newName}\n`;
                    summary += `   → Original: ${file.originalFile.name}\n`;
                    summary += `   → Move to: ${file.category}/\n\n`;
                });
                
                // Missing documents
                const missingDocs = checklistItems.filter(item => !item.assigned);
                if (missingDocs.length > 0) {
                    summary += `\n❌ MISSING DOCUMENTS (${missingDocs.length}):\n`;
                    summary += `==============================\n`;
                    missingDocs.forEach((item, index) => {
                        summary += `${index + 1}. ${item.document}\n`;
                        summary += `   Category: ${item.category}\n\n`;
                    });
                    
                    summary += `📧 Send login query to customer for missing documents.\n\n`;
                }
                
                // Statistics
                let totalMatchedFiles = 0;
                for (const [itemId, fileIds] of documentAssignments.entries()) {
                    totalMatchedFiles += fileIds.length;
                }
                
                summary += `📊 COMPLETION STATISTICS:\n`;
                summary += `=========================\n`;
                summary += `✅ Documents Matched: ${totalMatchedFiles} files\n`;
                summary += `❌ Documents Missing: ${missingDocs.length}\n`;
                summary += `📋 Total Required: ${checklistItems.length}\n`;
                const completionPercentage = Math.round((documentAssignments.size / checklistItems.length) * 100);
                summary += `📈 Completion Rate: ${completionPercentage}%\n\n`;
                
                // Next steps
                summary += `🎯 NEXT STEPS:\n`;
                summary += `=============\n`;
                summary += `1. All matched files have been downloaded to your PC\n`;
                summary += `2. Create the folder structure as shown above\n`;
                summary += `3. Move downloaded files to appropriate folders\n`;
                if (missingDocs.length > 0) {
                    summary += `4. Request missing documents from customer\n`;
                }
                summary += `5. Send organized documents to bank RM\n\n`;
                
                summary += `Generated by Loan Document Management System\n`;
                summary += `© ${new Date().getFullYear()} - Document Processing Automation\n`;
                
                // Create and download summary file
                const blob = new Blob([summary], { type: 'text/plain; charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${customerName.replace(/[^a-zA-Z0-9]/g, '_')}_Document_Organization_Plan.txt`;
                
                // Ensure the link is added to DOM for download
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // Clean up the URL
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                
                // Show success message with details
                let totalMatchedFiles = 0;
                for (const [itemId, fileIds] of documentAssignments.entries()) {
                    totalMatchedFiles += fileIds.length;
                }
                
                const successMessage = `📁 Document Organization Complete!\n\n` +
                      `📊 Summary:\n` +
                      `• ✅ Downloaded: ${totalMatchedFiles} organized files\n` +
                      `• ❌ Missing: ${missingDocs.length} documents\n` +
                      `• 📈 Completion: ${completionPercentage}%\n` +
                      `• 📁 Categories: ${documentsByCategory.size}\n\n` +
                      `📄 Downloaded to your PC:\n` +
                      `• All matched files with organized names\n` +
                      `• Organization plan document\n` +
                      `• Folder structure guide\n\n` +
                      `🎯 Check your Downloads folder and follow the organization plan!`;
                
                alert(successMessage);
                
                console.log('Organization plan generated successfully');
                
            } catch (error) {
                console.error('Error organizing documents:', error);
                alert(`❌ Error generating organization plan:\n\n${error.message}\n\nPlease try again or check the console for details.`);
            }
        }

        // Document Preview Functions
        function previewDocument(fileId) {
            const file = uploadedFiles.get(fileId);
            if (!file) return;
            
            const modal = safeGetElement('documentModal');
            const modalTitle = safeGetElement('modalTitle');
            const modalBody = safeGetElement('modalBody');
            
            if (modalTitle) modalTitle.textContent = file.name;
            if (modalBody) modalBody.innerHTML = '<div class="loading-spinner">Loading document...</div>';
            if (modal) modal.classList.add('show');
            
            // Add file analysis
            analyzeAndShowDocument(file.file, modalBody);
        }

        async function analyzeAndShowDocument(file, container) {
            if (!container) return;
            
            try {
                let content = '';
                
                if (file.type.startsWith('image/')) {
                    // Show image with simulated OCR analysis
                    const imageUrl = URL.createObjectURL(file);
                    const analysisText = await simulateImageOCR(file);
                    
                    content = `
                        <div class="file-analysis">
                            <div class="analysis-header">🤖 AI Document Analysis</div>
                            <div class="detected-content">
                                <strong>Detected Type:</strong> ${analysisText || 'Unknown'}<br>
                                <strong>File Type:</strong> Image (${file.type})<br>
                                <strong>Size:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                                <strong>Status:</strong> ✅ Image loaded successfully
                            </div>
                        </div>
                        <img src="${imageUrl}" alt="${file.name}" class="image-viewer" 
                             onload="console.log('Image loaded successfully')" 
                             onerror="console.error('Error loading image'); this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIFByZXZpZXc8L3RleHQ+PC9zdmc+'">
                    `;
                } else if (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')) {
                    // Show PDF with simulated text analysis
                    const analysisText = await simulatePDFTextExtraction(file);
                    const pdfUrl = URL.createObjectURL(file);
                    
                    content = `
                        <div class="file-analysis">
                            <div class="analysis-header">🤖 AI Document Analysis</div>
                            <div class="detected-content">
                                <strong>Detected Type:</strong> ${analysisText || 'PDF Document'}<br>
                                <strong>File Type:</strong> PDF<br>
                                <strong>Size:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                                <strong>Status:</strong> ✅ PDF ready for viewing
                            </div>
                        </div>
                        <div style="width: 100%; height: 500px; border: 2px solid #e2e8f0; border-radius: 10px; overflow: hidden;">
                            <iframe src="${pdfUrl}" 
                                    style="width: 100%; height: 100%; border: none;" 
                                    onload="console.log('PDF loaded successfully')"
                                    onerror="console.error('Error loading PDF')">
                                <p>PDF cannot be displayed. <a href="${pdfUrl}" target="_blank">Click here to download and view</a></p>
                            </iframe>
                        </div>
                    `;
                } else if (file.type.startsWith('text/') || file.name.toLowerCase().endsWith('.txt')) {
                    // Show text content
                    try {
                        const text = await file.text();
                        content = `
                            <div class="file-analysis">
                                <div class="analysis-header">📄 Text Document</div>
                                <div class="detected-content">
                                    <strong>File Type:</strong> Text Document<br>
                                    <strong>Size:</strong> ${(file.size / 1024).toFixed(2)} KB<br>
                                    <strong>Lines:</strong> ${text.split('\n').length}
                                </div>
                            </div>
                            <div class="text-viewer">${text || 'No text content found'}</div>
                        `;
                    } catch (error) {
                        content = `<div style="padding: 20px; text-align: center;">Error reading text file: ${error.message}</div>`;
                    }
                } else {
                    // For other file types, show file info and download option
                    const fileUrl = URL.createObjectURL(file);
                    content = `
                        <div class="file-analysis">
                            <div class="analysis-header">📁 File Information</div>
                            <div class="detected-content">
                                <strong>File Name:</strong> ${file.name}<br>
                                <strong>File Type:</strong> ${file.type || 'Unknown'}<br>
                                <strong>Size:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                                <strong>Last Modified:</strong> ${file.lastModified ? new Date(file.lastModified).toLocaleString() : 'Unknown'}<br><br>
                                <a href="${fileUrl}" download="${file.name}" 
                                   style="background: #4e54c8; color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none;">
                                   📥 Download File
                                </a><br><br>
                                <em>Preview not available for this file type. Use download button above.</em>
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = content;
                
            } catch (error) {
                console.error('Error loading document:', error);
                const fileUrl = URL.createObjectURL(file);
                container.innerHTML = `
                    <div style="text-align: center; color: #f56565; padding: 20px;">
                        <h3>⚠️ Error Loading Document</h3>
                        <p>Unable to preview this document.</p>
                        <br>
                        <a href="${fileUrl}" download="${file.name}" 
                           style="background: #4e54c8; color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none;">
                           📥 Download to View
                        </a>
                    </div>
                `;
            }
        }

        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = safeGetElement('documentModal');
            if (modal) {
                modal.classList.remove('show');
                
                // Clean up any object URLs
                const images = modal.querySelectorAll('img');
                const iframes = modal.querySelectorAll('iframe');
                images.forEach(img => URL.revokeObjectURL(img.src));
                iframes.forEach(iframe => URL.revokeObjectURL(iframe.src));
            }
        }

        // Add drag over effect for checklist items
        document.addEventListener('dragover', function(e) {
            const checklistItems = document.querySelectorAll('.checklist-item');
            checklistItems.forEach(item => {
                if (item !== e.target.closest('.checklist-item')) {
                    item.classList.remove('drop-target');
                }
            });
        });

        // Optional Google API Integration
        window.gapiLoaded = function() {
            console.log('📥 Google API loaded');
            gapiLoaded();
        };
        
        window.gisLoaded = function() {
            console.log('🔐 Google Identity loaded');
            gisLoaded();
        };
        
        // Graceful error handling - don't let Google API errors break the app
        window.addEventListener('error', function(e) {
            if (e.message === 'Script error.' || 
                (e.filename && (e.filename.includes('googleapis') || e.filename.includes('gsi')))) {
                console.warn('⚠️ Google API loading issue detected - disabling Google Drive integration');
                disableGoogleDriveIntegration();
                e.preventDefault(); // Prevent the error from bubbling up
                return true;
            }
        });
        
        // Additional safety check
        window.addEventListener('unhandledrejection', function(e) {
            if (e.reason && e.reason.toString().includes('gapi')) {
                console.warn('⚠️ Google API promise rejection - disabling Google Drive integration');
                disableGoogleDriveIntegration();
                e.preventDefault();
            }
        });
    </script>
    
    <!-- Optional Google APIs - won't block app if they fail -->
    <script>
        // Load Google APIs with timeout protection
        function loadGoogleAPI() {
            const script = document.createElement('script');
            script.src = 'https://apis.google.com/js/api.js';
            script.async = true;
            script.defer = true;
            script.onload = function() {
                if (typeof window.gapiLoaded === 'function') {
                    window.gapiLoaded();
                }
            };
            script.onerror = function() {
                console.warn('📛 Failed to load Google Drive API - continuing without it');
                disableGoogleDriveIntegration();
            };
            document.head.appendChild(script);
        }
        
        function loadGoogleIdentity() {
            const script = document.createElement('script');
            script.src = 'https://accounts.google.com/gsi/client';
            script.async = true;
            script.defer = true;
            script.onload = function() {
                if (typeof window.gisLoaded === 'function') {
                    window.gisLoaded();
                }
            };
            script.onerror = function() {
                console.warn('📛 Failed to load Google Identity - continuing without it');
                disableGoogleDriveIntegration();
            };
            document.head.appendChild(script);
        }
        
        // Load Google APIs after a short delay to not block main app
        setTimeout(() => {
            loadGoogleAPI();
            loadGoogleIdentity();
        }, 1000);
    </script>
</body>
</html>
