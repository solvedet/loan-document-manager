<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solvedet Loan Document Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-blue-600 text-white p-6 shadow-lg">
        <div class="container mx-auto">
            <h1 class="text-3xl font-bold">📋 Solvedet Loan Document Manager</h1>
            <p class="text-blue-100 mt-2">AI-powered document organization with Google Drive integration</p>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container mx-auto p-6 max-w-6xl">
        
        <!-- Google Drive Connection Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                ☁️ Google Drive Connection
            </h2>
            
            <!-- Connection Status -->
            <div id="google-status" class="mb-4 p-3 rounded-lg bg-gray-50 border">
                <span class="text-gray-600">⏳ Initializing Google Drive connection...</span>
            </div>
            
            <!-- Google Drive Actions -->
            <div class="flex flex-wrap gap-3">
                <button id="google-connect-btn" onclick="handleGoogleAuth()" 
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center transition duration-300">
                    🔗 Connect Google Account
                </button>
                
                <button id="google-drive-btn" onclick="openGoogleDrive()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center transition duration-300 opacity-50 cursor-not-allowed" disabled>
                    📂 Open Google Drive
                </button>
                
                <button onclick="loadGoogleDriveFiles()" 
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center transition duration-300">
                    📁 Load Drive Files
                </button>
            </div>
        </div>

        <!-- File Upload Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                📁 Upload Documents
            </h2>
            
            <!-- Upload Area -->
            <div id="upload-area" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors cursor-pointer">
                <input type="file" id="file-input" multiple accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png" class="hidden">
                <div class="space-y-2">
                    <div class="text-4xl">📄</div>
                    <p class="text-lg font-medium text-gray-700">Drop files here or click to browse</p>
                    <p class="text-sm text-gray-500">Supports: PDF, DOC, DOCX, TXT, JPG, PNG</p>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div id="upload-progress" class="mt-4 hidden">
                <div class="bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p class="text-sm text-gray-600 mt-1">Uploading files...</p>
            </div>
        </div>

        <!-- Document Preview -->
        <div id="document-preview" class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">📋 Document Preview</h2>
            <div id="file-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="text-gray-500 text-center py-8 col-span-full">
                    No documents uploaded yet. Upload files to see them here.
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid md:grid-cols-2 gap-6">
            
            <!-- Left Column: Document Checklist -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    ✅ Loan Document Checklist
                </h2>
                
                <!-- AI Auto-Match Button -->
                <button onclick="aiAutoMatch()" 
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg mb-4 shadow-lg transition duration-300 flex items-center justify-center">
                    🤖 AI Auto-Match Documents
                </button>
                
                <!-- Checklist Items -->
                <div class="space-y-2" id="checklist-container">
                    <button class="w-full text-left p-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition duration-300" data-checklist="Credit Report">
                        ❌ Credit Report
                    </button>
                    <button class="w-full text-left p-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition duration-300" data-checklist="Income Verification">
                        ❌ Income Verification
                    </button>
                    <button class="w-full text-left p-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition duration-300" data-checklist="Bank Statements">
                        ❌ Bank Statements
                    </button>
                    <button class="w-full text-left p-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition duration-300" data-checklist="Employment Letter">
                        ❌ Employment Letter
                    </button>
                    <button class="w-full text-left p-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition duration-300" data-checklist="Tax Returns">
                        ❌ Tax Returns
                    </button>
                    <button class="w-full text-left p-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition duration-300" data-checklist="Property Appraisal">
                        ❌ Property Appraisal
                    </button>
                    <button class="w-full text-left p-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition duration-300" data-checklist="Insurance Documents">
                        ❌ Insurance Documents
                    </button>
                    <button class="w-full text-left p-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition duration-300" data-checklist="Purchase Agreement">
                        ❌ Purchase Agreement
                    </button>
                </div>
                
                <!-- Progress Bar -->
                <div class="mt-6">
                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                        <span>Completion Progress</span>
                        <span id="progress-text">0/8 items</span>
                    </div>
                    <div class="bg-gray-200 rounded-full h-3">
                        <div id="progress-bar" class="bg-green-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Actions & Status -->
            <div class="space-y-6">
                
                <!-- Status Panel -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-3">📊 Status Panel</h3>
                    <div id="status-messages" class="space-y-2">
                        <div class="text-gray-500 text-sm">Ready to process documents...</div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4">🚀 Actions</h3>
                    <div class="space-y-3">
                        <button onclick="validateDocuments()" 
                                class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-300 flex items-center justify-center">
                            🔍 Validate All Documents
                        </button>
                        
                        <button onclick="generateReport()" 
                                class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-300 flex items-center justify-center">
                            📄 Generate Loan Report
                        </button>
                        
                        <button onclick="organizeAndDownload()" 
                                class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition duration-300 flex items-center justify-center">
                            📁 Organize & Download from Google Drive
                        </button>
                        
                        <!-- Organization Results -->
                        <div id="organization-result" class="mt-4"></div>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-3">📈 Quick Stats</h3>
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="bg-blue-50 p-3 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600" id="uploaded-count">0</div>
                            <div class="text-sm text-blue-600">Uploaded</div>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg">
                            <div class="text-2xl font-bold text-green-600" id="matched-count">0</div>
                            <div class="text-sm text-green-600">Matched</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Add global error handler
        window.addEventListener('error', function(e) {
            console.error('Script error:', e.error);
            showStatus('⚠️ A script error occurred. Some features may not work properly.', 'warning');
        });

        // Google API Configuration
        const CLIENT_ID = '346449855415-8l1ihn224h1tccv57le5bm81qtqcln6n.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyCRlPzpHXYUpswkdZPWKANfU8ID2tId39s';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        
        // Scope for Google Drive API (read and write access)
        const SCOPE = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive';

        let isSignedIn = false;
        let uploadedFiles = [];
        let gapiLoaded = false;

        // Initialize Google API with better error handling
        function initializeGapi() {
            try {
                if (typeof gapi === 'undefined') {
                    console.error('Google API not loaded');
                    showGoogleStatus('Google API failed to load. Please refresh the page.', 'error');
                    return;
                }

                gapi.load('auth2:client', {
                    callback: () => {
                        gapi.client.init({
                            apiKey: API_KEY,
                            clientId: CLIENT_ID,
                            discoveryDocs: DISCOVERY_DOCS,
                            scope: SCOPE
                        }).then(() => {
                            console.log('Google API initialized successfully');
                            gapiLoaded = true;
                            const authInstance = gapi.auth2.getAuthInstance();
                            isSignedIn = authInstance.isSignedIn.get();
                            updateGoogleStatus();
                            
                            authInstance.isSignedIn.listen(updateGoogleStatus);
                        }).catch(error => {
                            console.error('Error initializing Google API:', error);
                            showGoogleStatus('Failed to initialize Google Drive connection. Please check your internet connection.', 'error');
                        });
                    },
                    onerror: () => {
                        console.error('Error loading Google API modules');
                        showGoogleStatus('Failed to load Google API modules.', 'error');
                    }
                });
            } catch (error) {
                console.error('Error in initializeGapi:', error);
                showGoogleStatus('Google API initialization failed.', 'error');
            }
        }

        // Wait for Google API to load
        function waitForGapi() {
            if (typeof gapi !== 'undefined') {
                initializeGapi();
            } else {
                console.log('Waiting for Google API to load...');
                setTimeout(waitForGapi, 100);
            }
        }

        // Update Google connection status
        function updateGoogleStatus() {
            const statusDiv = document.getElementById('google-status');
            const connectBtn = document.getElementById('google-connect-btn');
            const driveBtn = document.getElementById('google-drive-btn');
            
            if (isSignedIn) {
                statusDiv.innerHTML = '<span class="text-green-600">✅ Connected to Google Drive</span>';
                connectBtn.textContent = '🔓 Disconnect';
                connectBtn.className = 'bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg flex items-center transition duration-300';
                driveBtn.disabled = false;
                driveBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center transition duration-300';
            } else {
                statusDiv.innerHTML = '<span class="text-red-600">❌ Not connected to Google Drive</span>';
                connectBtn.textContent = '🔗 Connect Google Account';
                connectBtn.className = 'bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center transition duration-300';
                driveBtn.disabled = true;
                driveBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center transition duration-300 opacity-50 cursor-not-allowed';
            }
        }

        // Handle Google authentication
        function handleGoogleAuth() {
            if (!gapiLoaded) {
                showGoogleStatus('Google API is still loading. Please wait...', 'warning');
                return;
            }

            try {
                const authInstance = gapi.auth2.getAuthInstance();
                
                if (isSignedIn) {
                    authInstance.signOut().then(() => {
                        isSignedIn = false;
                        showGoogleStatus('Disconnected from Google Drive.', 'info');
                    }).catch(error => {
                        console.error('Sign-out error:', error);
                        showGoogleStatus('Error disconnecting from Google Drive.', 'error');
                    });
                } else {
                    authInstance.signIn().then(() => {
                        isSignedIn = true;
                        showGoogleStatus('Successfully connected to Google Drive!', 'success');
                    }).catch(error => {
                        console.error('Sign-in error:', error);
                        if (error.error === 'popup_blocked_by_browser') {
                            showGoogleStatus('Pop-up blocked. Please allow pop-ups and try again.', 'error');
                        } else {
                            showGoogleStatus('Failed to connect to Google Drive. Please try again.', 'error');
                        }
                    });
                }
            } catch (error) {
                console.error('Google auth error:', error);
                showGoogleStatus('Authentication error occurred.', 'error');
            }
        }

        // Show Google status messages
        function showGoogleStatus(message, type) {
            const statusDiv = document.getElementById('google-status');
            const colors = {
                success: 'bg-green-50 border-green-200 text-green-800',
                error: 'bg-red-50 border-red-200 text-red-800',
                info: 'bg-blue-50 border-blue-200 text-blue-800'
            };
            
            statusDiv.className = `p-3 rounded-lg border ${colors[type] || colors.info}`;
            statusDiv.textContent = message;
        }

        // Load Google Drive files
        async function loadGoogleDriveFiles() {
            if (!gapiLoaded) {
                showGoogleStatus('Google API is still loading. Please wait...', 'warning');
                return;
            }

            if (!isSignedIn) {
                showGoogleStatus('Please connect to Google Drive first.', 'error');
                return;
            }

            try {
                showGoogleStatus('Loading files from Google Drive...', 'info');
                
                const response = await gapi.client.drive.files.list({
                    pageSize: 50,
                    fields: 'files(id, name, mimeType, size, createdTime)',
                    q: "mimeType contains 'pdf' or mimeType contains 'document' or mimeType contains 'image'"
                });

                const files = response.result.files;
                if (files && files.length > 0) {
                    displayGoogleDriveFiles(files);
                    showGoogleStatus(`Loaded ${files.length} files from Google Drive.`, 'success');
                } else {
                    showGoogleStatus('No compatible files found in Google Drive.', 'info');
                }
            } catch (error) {
                console.error('Error loading Google Drive files:', error);
                showGoogleStatus('Failed to load files from Google Drive. Please try again.', 'error');
            }
        }

        // Display Google Drive files
        function displayGoogleDriveFiles(files) {
            const fileGrid = document.getElementById('file-grid');
            
            files.forEach(file => {
                const fileElement = document.createElement('div');
                fileElement.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow';
                fileElement.setAttribute('data-filename', file.name);
                
                fileElement.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center text-white font-bold">
                                📄
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">${file.name}</p>
                            <p class="text-xs text-gray-500">From Google Drive</p>
                            <p class="text-xs text-gray-400">Size: ${file.size ? Math.round(file.size/1024) + ' KB' : 'Unknown'}</p>
                        </div>
                    </div>
                    <div class="mt-3 flex justify-between items-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            Google Drive
                        </span>
                        <select class="text-xs border border-gray-300 rounded px-2 py-1" onchange="matchFileToChecklist('${file.name}', this.value)">
                            <option value="">Match to...</option>
                            <option value="Credit Report">Credit Report</option>
                            <option value="Income Verification">Income Verification</option>
                            <option value="Bank Statements">Bank Statements</option>
                            <option value="Employment Letter">Employment Letter</option>
                            <option value="Tax Returns">Tax Returns</option>
                            <option value="Property Appraisal">Property Appraisal</option>
                            <option value="Insurance Documents">Insurance Documents</option>
                            <option value="Purchase Agreement">Purchase Agreement</option>
                        </select>
                    </div>
                `;
                
                fileGrid.appendChild(fileElement);
            });
            
            updateUploadCount();
        }

        // Open Google Drive
        function openGoogleDrive() {
            if (!isSignedIn) {
                showGoogleStatus('Please connect to Google Drive first.', 'error');
                return;
            }
            
            // Open Google Drive in new tab
            window.open('https://drive.google.com', '_blank');
            showGoogleStatus('Google Drive opened in new tab.', 'success');
        }

        // File upload handling
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('file-input');
            
            // Initialize Google API when page loads
            waitForGapi();
            
            // Set up file upload handling
            if (uploadArea && fileInput) {
                uploadArea.addEventListener('click', () => fileInput.click());
                
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('border-blue-400', 'bg-blue-50');
                });
                
                uploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
                    const files = Array.from(e.dataTransfer.files);
                    handleFiles(files);
                });
                
                fileInput.addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    handleFiles(files);
                });
            }
            
            // Show initial status
            showStatus('✅ Loan Document Manager loaded successfully!', 'success');
        });

        function handleFiles(files) {
            const progressContainer = document.getElementById('upload-progress');
            const progressBar = progressContainer.querySelector('div div');
            
            progressContainer.classList.remove('hidden');
            
            let progress = 0;
            const increment = 100 / files.length;
            
            files.forEach((file, index) => {
                setTimeout(() => {
                    uploadedFiles.push(file);
                    displayFile(file);
                    progress += increment;
                    progressBar.style.width = `${progress}%`;
                    
                    if (index === files.length - 1) {
                        setTimeout(() => {
                            progressContainer.classList.add('hidden');
                            showStatus(`✅ Successfully uploaded ${files.length} file(s)`, 'success');
                            updateUploadCount();
                        }, 500);
                    }
                }, index * 300);
            });
        }

        function displayFile(file) {
            const fileGrid = document.getElementById('file-grid');
            
            // Remove "no documents" message if present
            const noDocsMessage = fileGrid.querySelector('.text-gray-500');
            if (noDocsMessage && noDocsMessage.textContent.includes('No documents uploaded')) {
                noDocsMessage.remove();
            }
            
            const fileElement = document.createElement('div');
            fileElement.className = 'bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow';
            fileElement.setAttribute('data-filename', file.name);
            
            const fileIcon = getFileIcon(file.type);
            const fileSize = (file.size / 1024).toFixed(1);
            
            fileElement.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 bg-gray-500 rounded-lg flex items-center justify-center text-white font-bold">
                            ${fileIcon}
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 truncate">${file.name}</p>
                        <p class="text-xs text-gray-500">Size: ${fileSize} KB</p>
                        <p class="text-xs text-gray-400">Type: ${file.type || 'Unknown'}</p>
                    </div>
                </div>
                <div class="mt-3 flex justify-between items-center">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                        Uploaded
                    </span>
                    <select class="text-xs border border-gray-300 rounded px-2 py-1" onchange="matchFileToChecklist('${file.name}', this.value)">
                        <option value="">Match to...</option>
                        <option value="Credit Report">Credit Report</option>
                        <option value="Income Verification">Income Verification</option>
                        <option value="Bank Statements">Bank Statements</option>
                        <option value="Employment Letter">Employment Letter</option>
                        <option value="Tax Returns">Tax Returns</option>
                        <option value="Property Appraisal">Property Appraisal</option>
                        <option value="Insurance Documents">Insurance Documents</option>
                        <option value="Purchase Agreement">Purchase Agreement</option>
                    </select>
                </div>
            `;
            
            fileGrid.appendChild(fileElement);
        }

        function getFileIcon(fileType) {
            if (fileType.includes('pdf')) return '📄';
            if (fileType.includes('image')) return '🖼️';
            if (fileType.includes('document') || fileType.includes('word')) return '📝';
            if (fileType.includes('spreadsheet') || fileType.includes('excel')) return '📊';
            return '📎';
        }

        function matchFileToChecklist(fileName, checklistItem) {
            const button = document.querySelector(`[data-checklist="${checklistItem}"]`);
            const fileElement = document.querySelector(`[data-filename="${fileName}"]`);
            
            if (button && fileElement) {
                button.classList.remove('bg-red-500', 'hover:bg-red-600');
                button.classList.add('bg-green-500', 'hover:bg-green-600');
                button.innerHTML = `✅ ${checklistItem}`;
                
                // Move file from preview to matched files section
                const matchedSection = document.getElementById('matched-files-section');
                if (!matchedSection) {
                    // Create matched files section if it doesn't exist
                    const newSection = document.createElement('div');
                    newSection.id = 'matched-files-section';
                    newSection.className = 'bg-green-50 border border-green-200 rounded-lg p-4 mt-4';
                    newSection.innerHTML = `
                        <h3 class="text-lg font-semibold text-green-800 mb-3">✅ Matched Documents</h3>
                        <div id="matched-files-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    `;
                    document.getElementById('document-preview').appendChild(newSection);
                }
                
                // Move file element to matched section
                const matchedGrid = document.getElementById('matched-files-grid');
                const clonedFile = fileElement.cloneNode(true);
                clonedFile.classList.add('opacity-90', 'border-green-300');
                matchedGrid.appendChild(clonedFile);
                
                // Remove from original location
                fileElement.remove();
                
                // Store match in global object for organize function
                if (!window.fileMatches) window.fileMatches = {};
                window.fileMatches[fileName] = checklistItem;
                
                showStatus(`✅ Matched: ${fileName} → ${checklistItem}`, 'success');
            }
        }

        function updateProgress() {
            const checklistButtons = document.querySelectorAll('[data-checklist]');
            const completedItems = Array.from(checklistButtons).filter(btn => 
                btn.classList.contains('bg-green-500')
            ).length;
            
            const totalItems = checklistButtons.length;
            const percentage = (completedItems / totalItems) * 100;
            
            document.getElementById('progress-bar').style.width = `${percentage}%`;
            document.getElementById('progress-text').textContent = `${completedItems}/${totalItems} items`;
            document.getElementById('matched-count').textContent = completedItems;
        }

        function updateUploadCount() {
            const fileElements = document.querySelectorAll('#file-grid > div:not(.text-gray-500)');
            document.getElementById('uploaded-count').textContent = fileElements.length;
        }

        function aiAutoMatch() {
            showStatus('🤖 AI analyzing documents...', 'info');
            
            const fileElements = document.querySelectorAll('#file-grid [data-filename]');
            const checklistItems = [
                'Credit Report', 'Income Verification', 'Bank Statements', 
                'Employment Letter', 'Tax Returns', 'Property Appraisal', 
                'Insurance Documents', 'Purchase Agreement'
            ];
            
            let matchCount = 0;
            
            fileElements.forEach((element, index) => {
                setTimeout(() => {
                    const fileName = element.getAttribute('data-filename').toLowerCase();
                    let bestMatch = null;
                    
                    // Simple AI matching logic
                    if (fileName.includes('credit') || fileName.includes('score')) {
                        bestMatch = 'Credit Report';
                    } else if (fileName.includes('income') || fileName.includes('salary') || fileName.includes('pay')) {
                        bestMatch = 'Income Verification';
                    } else if (fileName.includes('bank') || fileName.includes('statement')) {
                        bestMatch = 'Bank Statements';
                    } else if (fileName.includes('employment') || fileName.includes('job') || fileName.includes('work')) {
                        bestMatch = 'Employment Letter';
                    } else if (fileName.includes('tax') || fileName.includes('1040') || fileName.includes('w2')) {
                        bestMatch = 'Tax Returns';
                    } else if (fileName.includes('appraisal') || fileName.includes('value') || fileName.includes('property')) {
                        bestMatch = 'Property Appraisal';
                    } else if (fileName.includes('insurance') || fileName.includes('policy')) {
                        bestMatch = 'Insurance Documents';
                    } else if (fileName.includes('purchase') || fileName.includes('agreement') || fileName.includes('contract')) {
                        bestMatch = 'Purchase Agreement';
                    } else {
                        // Random assignment for demo
                        const availableItems = checklistItems.filter(item => {
                            const button = document.querySelector(`[data-checklist="${item}"]`);
                            return button && button.classList.contains('bg-red-500');
                        });
                        if (availableItems.length > 0) {
                            bestMatch = availableItems[Math.floor(Math.random() * availableItems.length)];
                        }
                    }
                    
                    if (bestMatch) {
                        matchFileToChecklist(element.getAttribute('data-filename'), bestMatch);
                        matchCount++;
                    }
                    
                    updateProgress();
                    
                    // Show completion message
                    if (index === fileElements.length - 1) {
                        setTimeout(() => {
                            showStatus(`🎉 AI matched ${matchCount} documents automatically!`, 'success');
                        }, 500);
                    }
                }, index * 800);
            });
        }

        // Organize and Download - Real Google Drive Integration
        async function organizeAndDownload() {
            if (!gapiLoaded) {
                showStatus('Google API is still loading. Please wait...', 'warning');
                return;
            }

            if (!isSignedIn) {
                showStatus('Please connect to Google Drive first.', 'error');
                return;
            }

            if (!window.fileMatches || Object.keys(window.fileMatches).length === 0) {
                showStatus('No matched files to organize. Please match some documents first.', 'warning');
                return;
            }

            showStatus('🚀 Organizing files in Google Drive...', 'info');

            try {
                // Create a folder for organized loan documents
                const folderName = `Loan Documents - ${new Date().toLocaleDateString()}`;
                const folderMetadata = {
                    name: folderName,
                    mimeType: 'application/vnd.google-apps.folder'
                };

                const folderResponse = await gapi.client.drive.files.create({
                    resource: folderMetadata
                });

                const folderId = folderResponse.result.id;
                showStatus(`📁 Created folder: ${folderName}`, 'success');

                // Create subfolders for each document type
                const documentTypes = [...new Set(Object.values(window.fileMatches))];
                const subfolders = {};

                for (const docType of documentTypes) {
                    const subfolderMetadata = {
                        name: docType,
                        mimeType: 'application/vnd.google-apps.folder',
                        parents: [folderId]
                    };

                    const subfolderResponse = await gapi.client.drive.files.create({
                        resource: subfolderMetadata
                    });

                    subfolders[docType] = subfolderResponse.result.id;
                    showStatus(`📂 Created subfolder: ${docType}`, 'info');
                }

                // Move matched files to appropriate subfolders
                let movedCount = 0;
                for (const [fileName, docType] of Object.entries(window.fileMatches)) {
                    try {
                        // Find the file in Google Drive by name
                        const searchResponse = await gapi.client.drive.files.list({
                            q: `name='${fileName}'`,
                            fields: 'files(id, name)'
                        });

                        if (searchResponse.result.files.length > 0) {
                            const fileId = searchResponse.result.files[0].id;
                            const targetFolderId = subfolders[docType];

                            // Move file to subfolder
                            await gapi.client.drive.files.update({
                                fileId: fileId,
                                addParents: targetFolderId,
                                removeParents: 'root'
                            });

                            movedCount++;
                            showStatus(`📋 Moved: ${fileName} → ${docType}`, 'success');
                        }
                    } catch (moveError) {
                        console.warn(`Could not move file ${fileName}:`, moveError);
                        showStatus(`⚠️ Could not move: ${fileName}`, 'warning');
                    }
                }

                // Create summary document
                const summaryContent = `Loan Document Organization Summary
Generated: ${new Date().toLocaleString()}

Organized Folder: ${folderName}
Total Files Organized: ${movedCount}

Document Categories:
${documentTypes.map(type => `• ${type}: ${Object.values(window.fileMatches).filter(t => t === type).length} files`).join('\n')}

File Organization:
${Object.entries(window.fileMatches).map(([file, type]) => `• ${file} → ${type}`).join('\n')}

This summary was created by Solvedet Loan Document Manager.
`;

                const summaryBlob = new Blob([summaryContent], { type: 'text/plain' });
                const summaryMetadata = {
                    name: `Loan Organization Summary - ${new Date().toLocaleDateString()}.txt`,
                    parents: [folderId]
                };

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(summaryMetadata)], { type: 'application/json' }));
                form.append('file', summaryBlob);

                await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: new Headers({ 'Authorization': `Bearer ${gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token}` }),
                    body: form
                });

                // Generate shareable link
                await gapi.client.drive.permissions.create({
                    fileId: folderId,
                    resource: {
                        role: 'reader',
                        type: 'anyone'
                    }
                });

                const folderLink = `https://drive.google.com/drive/folders/${folderId}`;

                // Show completion message with link
                const resultDiv = document.getElementById('organization-result');
                resultDiv.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-green-800 mb-4">🎉 Organization Complete!</h3>
                        <div class="space-y-3">
                            <p><strong>📁 Folder Created:</strong> ${folderName}</p>
                            <p><strong>📋 Files Organized:</strong> ${movedCount} documents</p>
                            <p><strong>📂 Categories:</strong> ${documentTypes.length} types</p>
                            <div class="mt-4">
                                <a href="${folderLink}" target="_blank" 
                                   class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                                    🚀 Open Organized Folder in Google Drive
                                </a>
                            </div>
                        </div>
                    </div>
                `;

                showStatus(`✅ Successfully organized ${movedCount} files in Google Drive!`, 'success');

            } catch (error) {
                console.error('Organization error:', error);
                showStatus(`❌ Error organizing files: ${error.message}`, 'error');
            }
        }

        function validateDocuments() {
            showStatus('🔍 Validating all documents...', 'info');
            
            setTimeout(() => {
                const checklistButtons = document.querySelectorAll('[data-checklist]');
                const completedItems = Array.from(checklistButtons).filter(btn => 
                    btn.classList.contains('bg-green-500')
                ).length;
                const totalItems = checklistButtons.length;
                const completionRate = Math.round((completedItems / totalItems) * 100);
                
                if (completionRate === 100) {
                    showStatus('✅ All documents validated! Loan application is complete.', 'success');
                } else if (completionRate >= 75) {
                    showStatus(`⚠️ Validation: ${completionRate}% complete. Almost ready for submission!`, 'warning');
                } else {
                    showStatus(`❌ Validation: ${completionRate}% complete. More documents needed.`, 'error');
                }
            }, 2000);
        }

        function generateReport() {
            showStatus('📄 Generating loan compliance report...', 'info');
            
            setTimeout(() => {
                const checklistButtons = document.querySelectorAll('[data-checklist]');
                const completedItems = Array.from(checklistButtons)
                    .filter(btn => btn.classList.contains('bg-green-500'))
                    .map(btn => btn.dataset.checklist);
                
                const missingItems = Array.from(checklistButtons)
                    .filter(btn => btn.classList.contains('bg-red-500'))
                    .map(btn => btn.dataset.checklist);
                
                const report = `Solvedet Loan Document Compliance Report
Generated: ${new Date().toLocaleString()}

LOAN APPLICATION STATUS: ${completedItems.length}/${checklistButtons.length} DOCUMENTS RECEIVED

✅ RECEIVED DOCUMENTS (${completedItems.length}):
${completedItems.map(item => `• ${item}`).join('\n')}

❌ MISSING DOCUMENTS (${missingItems.length}):
${missingItems.map(item => `• ${item}`).join('\n')}

📊 OVERALL COMPLETION: ${Math.round(completedItems.length/checklistButtons.length*100)}%

STATUS: ${completedItems.length === checklistButtons.length ? 'READY FOR UNDERWRITING' : 'PENDING ADDITIONAL DOCUMENTATION'}

This report was generated by Solvedet Loan Document Manager.
For questions, contact: creditops@solvedet.com
`;
                
                // Create and download the report
                const blob = new Blob([report], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `solvedet-loan-report-${Date.now()}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showStatus('📄 Loan compliance report downloaded!', 'success');
            }, 2000);
        }

        function showStatus(message, type = 'info') {
            const statusContainer = document.getElementById('status-messages');
            const statusElement = document.createElement('div');
            
            const colors = {
                success: 'bg-green-100 text-green-800 border-green-200',
                error: 'bg-red-100 text-red-800 border-red-200',
                warning: 'bg-yellow-100 text-yellow-800 border-yellow-200',
                info: 'bg-blue-100 text-blue-800 border-blue-200'
            };
            
            statusElement.className = `p-2 rounded border text-sm ${colors[type] || colors.info}`;
            statusElement.textContent = message;
            
            statusContainer.insertBefore(statusElement, statusContainer.firstChild);
            
            // Remove old messages (keep only last 3)
            while (statusContainer.children.length > 3) {
                statusContainer.removeChild(statusContainer.lastChild);
            }
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (statusElement.parentNode) {
                    statusElement.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
