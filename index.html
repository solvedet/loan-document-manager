<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solvedet Loan Document Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <style>
        .drag-over {
            background-color: #dbeafe !important;
            border-color: #3b82f6 !important;
            transform: scale(1.02);
        }
        .dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }
        .drop-zone {
            transition: all 0.3s ease;
        }
        .file-tile {
            cursor: move;
            transition: all 0.3s ease;
        }
        .file-tile:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-blue-600 text-white p-6 shadow-lg">
        <div class="container mx-auto">
            <h1 class="text-3xl font-bold">üìã Solvedet Loan Document Manager</h1>
            <p class="text-blue-100 mt-2">AI-powered document organization with drag & drop functionality</p>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container mx-auto p-6 max-w-6xl">
        
        <!-- Google Drive Connection Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                ‚òÅÔ∏è Google Drive Connection
            </h2>
            
            <!-- Connection Status -->
            <div id="google-status" class="mb-4 p-3 rounded-lg bg-gray-50 border">
                <span class="text-gray-600">‚è≥ Initializing Google Drive connection...</span>
            </div>
            
            <!-- Google Drive Actions -->
            <div class="flex flex-wrap gap-3">
                <button id="google-connect-btn" onclick="handleGoogleAuth()" 
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center transition duration-300">
                    üîó Connect Google Account
                </button>
                
                <button id="google-drive-btn" onclick="openGoogleDrive()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center transition duration-300 opacity-50 cursor-not-allowed" disabled>
                    üìÇ Open Google Drive
                </button>
                
                <button onclick="loadGoogleDriveFiles()" 
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center transition duration-300">
                    üìÅ Load Drive Files
                </button>
            </div>
        </div>

        <!-- File Upload Section -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center">
                üìÅ Upload Documents
            </h2>
            
            <!-- Upload Area -->
            <div id="upload-area" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors cursor-pointer">
                <input type="file" id="file-input" multiple accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png" class="hidden">
                <div class="space-y-2">
                    <div class="text-4xl">üìÑ</div>
                    <p class="text-lg font-medium text-gray-700">Drop files here or click to browse</p>
                    <p class="text-sm text-gray-500">Supports: PDF, DOC, DOCX, TXT, JPG, PNG</p>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div id="upload-progress" class="mt-4 hidden">
                <div class="bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p class="text-sm text-gray-600 mt-1">Uploading files...</p>
            </div>
        </div>

        <!-- Document Preview -->
        <div id="document-preview" class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">üìã Document Preview <span class="text-sm font-normal text-gray-500">(Drag files to checklist items)</span></h2>
            <div id="file-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="text-gray-500 text-center py-8 col-span-full">
                    No documents uploaded yet. Upload files to see them here.
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid md:grid-cols-2 gap-6">
            
            <!-- Left Column: Document Checklist -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    ‚úÖ Loan Document Checklist <span class="text-sm font-normal text-gray-500 ml-2">(Drop files here)</span>
                </h2>
                
                <!-- AI Auto-Match Button -->
                <button onclick="aiAutoMatch()" 
                        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg mb-4 shadow-lg transition duration-300 flex items-center justify-center">
                    ü§ñ AI Auto-Match Documents
                </button>
                
                <!-- Checklist Items -->
                <div class="space-y-2" id="checklist-container">
                    <div class="w-full text-left p-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition duration-300 drop-zone" 
                         data-checklist="Credit Report" 
                         ondragover="allowDrop(event)" 
                         ondrop="dropFile(event, 'Credit Report')">
                        ‚ùå Credit Report
                    </div>
                    <div class="w-full text-left p-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition duration-300 drop-zone" 
                         data-checklist="Income Verification" 
                         ondragover="allowDrop(event)" 
                         ondrop="dropFile(event, 'Income Verification')">
                        ‚ùå Income Verification
                    </div>
                    <div class="w-full text-left p-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition duration-300 drop-zone" 
                         data-checklist="Bank Statements" 
                         ondragover="allowDrop(event)" 
                         ondrop="dropFile(event, 'Bank Statements')">
                        ‚ùå Bank Statements
                    </div>
                    <div class="w-full text-left p-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition duration-300 drop-zone" 
                         data-checklist="Employment Letter" 
                         ondragover="allowDrop(event)" 
                         ondrop="dropFile(event, 'Employment Letter')">
                        ‚ùå Employment Letter
                    </div>
                    <div class="w-full text-left p-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition duration-300 drop-zone" 
                         data-checklist="Tax Returns" 
                         ondragover="allowDrop(event)" 
                         ondrop="dropFile(event, 'Tax Returns')">
                        ‚ùå Tax Returns
                    </div>
                    <div class="w-full text-left p-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition duration-300 drop-zone" 
                         data-checklist="Property Appraisal" 
                         ondragover="allowDrop(event)" 
                         ondrop="dropFile(event, 'Property Appraisal')">
                        ‚ùå Property Appraisal
                    </div>
                    <div class="w-full text-left p-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition duration-300 drop-zone" 
                         data-checklist="Insurance Documents" 
                         ondragover="allowDrop(event)" 
                         ondrop="dropFile(event, 'Insurance Documents')">
                        ‚ùå Insurance Documents
                    </div>
                    <div class="w-full text-left p-3 bg-red-500 hover:bg-red-600 text-white rounded-lg transition duration-300 drop-zone" 
                         data-checklist="Purchase Agreement" 
                         ondragover="allowDrop(event)" 
                         ondrop="dropFile(event, 'Purchase Agreement')">
                        ‚ùå Purchase Agreement
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="mt-6">
                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                        <span>Completion Progress</span>
                        <span id="progress-text">0/8 items</span>
                    </div>
                    <div class="bg-gray-200 rounded-full h-3">
                        <div id="progress-bar" class="bg-green-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Actions & Status -->
            <div class="space-y-6">
                
                <!-- Status Panel -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-3">üìä Status Panel</h3>
                    <div id="status-messages" class="space-y-2">
                        <div class="text-gray-500 text-sm">Ready to process documents...</div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4">üöÄ Actions</h3>
                    <div class="space-y-3">
                        <button onclick="validateDocuments()" 
                                class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-300 flex items-center justify-center">
                            üîç Validate All Documents
                        </button>
                        
                        <button onclick="generateReport()" 
                                class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition duration-300 flex items-center justify-center">
                            üìÑ Generate Loan Report
                        </button>
                        
                        <button onclick="organizeAndDownload()" 
                                class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition duration-300 flex items-center justify-center">
                            üìÅ Organize & Download to PC
                        </button>
                        
                        <!-- Organization Results -->
                        <div id="organization-result" class="mt-4"></div>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-3">üìà Quick Stats</h3>
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="bg-blue-50 p-3 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600" id="uploaded-count">0</div>
                            <div class="text-sm text-blue-600">Uploaded</div>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg">
                            <div class="text-2xl font-bold text-green-600" id="matched-count">0</div>
                            <div class="text-sm text-green-600">Matched</div>
                        </div>
                    </div>
                </div>

                <!-- Matched Files Display -->
                <div id="matched-files-section" class="bg-green-50 border border-green-200 rounded-lg p-4 hidden">
                    <h3 class="text-lg font-semibold text-green-800 mb-3">‚úÖ Matched Documents</h3>
                    <div id="matched-files-grid" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Add global error handler
        window.addEventListener('error', function(e) {
            console.error('Script error:', e.error);
            showStatus('‚ö†Ô∏è A script error occurred. Some features may not work properly.', 'warning');
        });

        // Google API Configuration - Using non-sensitive scopes
        const CLIENT_ID = '346449855415-8l1ihn224h1tccv57le5bm81qtqcln6n.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyCRlPzpHXYUpswkdZPWKANfU8ID2tId39s';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        
        // Using non-sensitive scopes for immediate access
        const SCOPE = 'https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/userinfo.email';

        let isSignedIn = false;
        let uploadedFiles = [];
        let gapiLoaded = false;
        let fileMatches = {};

        // Initialize Google API with better error handling
        function initializeGapi() {
            try {
                if (typeof gapi === 'undefined') {
                    console.error('Google API not loaded');
                    showGoogleStatus('Google API failed to load. Please refresh the page.', 'error');
                    return;
                }

                gapi.load('auth2:client', {
                    callback: () => {
                        gapi.client.init({
                            apiKey: API_KEY,
                            clientId: CLIENT_ID,
                            discoveryDocs: DISCOVERY_DOCS,
                            scope: SCOPE
                        }).then(() => {
                            console.log('Google API initialized successfully');
                            gapiLoaded = true;
                            const authInstance = gapi.auth2.getAuthInstance();
                            isSignedIn = authInstance.isSignedIn.get();
                            updateGoogleStatus();
                            
                            authInstance.isSignedIn.listen(updateGoogleStatus);
                        }).catch(error => {
                            console.error('Error initializing Google API:', error);
                            showGoogleStatus('Failed to initialize Google Drive connection. Check internet connection.', 'error');
                        });
                    },
                    onerror: () => {
                        console.error('Error loading Google API modules');
                        showGoogleStatus('Failed to load Google API modules.', 'error');
                    }
                });
            } catch (error) {
                console.error('Error in initializeGapi:', error);
                showGoogleStatus('Google API initialization failed.', 'error');
            }
        }

        // Wait for Google API to load
        function waitForGapi() {
            if (typeof gapi !== 'undefined') {
                initializeGapi();
            } else {
                console.log('Waiting for Google API to load...');
                setTimeout(waitForGapi, 100);
            }
        }

        // Update Google connection status
        function updateGoogleStatus() {
            const statusDiv = document.getElementById('google-status');
            const connectBtn = document.getElementById('google-connect-btn');
            const driveBtn = document.getElementById('google-drive-btn');
            
            if (isSignedIn) {
                statusDiv.innerHTML = '<span class="text-green-600">‚úÖ Connected to Google Drive</span>';
                connectBtn.textContent = 'üîì Disconnect';
                connectBtn.className = 'bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg flex items-center transition duration-300';
                driveBtn.disabled = false;
                driveBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center transition duration-300';
            } else {
                statusDiv.innerHTML = '<span class="text-red-600">‚ùå Not connected to Google Drive</span>';
                connectBtn.textContent = 'üîó Connect Google Account';
                connectBtn.className = 'bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center transition duration-300';
                driveBtn.disabled = true;
                driveBtn.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center transition duration-300 opacity-50 cursor-not-allowed';
            }
        }

        // Handle Google authentication
        function handleGoogleAuth() {
            if (!gapiLoaded) {
                showGoogleStatus('Google API is still loading. Please wait...', 'warning');
                return;
            }

            try {
                const authInstance = gapi.auth2.getAuthInstance();
                
                if (isSignedIn) {
                    authInstance.signOut().then(() => {
                        isSignedIn = false;
                        showGoogleStatus('Disconnected from Google Drive.', 'info');
                    }).catch(error => {
                        console.error('Sign-out error:', error);
                        showGoogleStatus('Error disconnecting from Google Drive.', 'error');
                    });
                } else {
                    authInstance.signIn().then(() => {
                        isSignedIn = true;
                        showGoogleStatus('Successfully connected to Google Drive!', 'success');
                    }).catch(error => {
                        console.error('Sign-in error:', error);
                        if (error.error === 'popup_blocked_by_browser') {
                            showGoogleStatus('Pop-up blocked. Please allow pop-ups and try again.', 'error');
                        } else {
                            showGoogleStatus('Failed to connect to Google Drive. Please try again.', 'error');
                        }
                    });
                }
            } catch (error) {
                console.error('Google auth error:', error);
                showGoogleStatus('Authentication error occurred.', 'error');
            }
        }

        // Show Google status messages
        function showGoogleStatus(message, type) {
            const statusDiv = document.getElementById('google-status');
            const colors = {
                success: 'bg-green-50 border-green-200 text-green-800',
                error: 'bg-red-50 border-red-200 text-red-800',
                info: 'bg-blue-50 border-blue-200 text-blue-800',
                warning: 'bg-yellow-50 border-yellow-200 text-yellow-800'
            };
            
            statusDiv.className = `p-3 rounded-lg border ${colors[type] || colors.info}`;
            statusDiv.textContent = message;
        }

        // Load Google Drive files
        async function loadGoogleDriveFiles() {
            if (!gapiLoaded) {
                showGoogleStatus('Google API is still loading. Please wait...', 'warning');
                return;
            }

            if (!isSignedIn) {
                showGoogleStatus('Please connect to Google Drive first.', 'error');
                return;
            }

            try {
                showGoogleStatus('Loading files from Google Drive...', 'info');
                
                const response = await gapi.client.drive.files.list({
                    pageSize: 50,
                    fields: 'files(id, name, mimeType, size, createdTime)',
                    q: "mimeType contains 'pdf' or mimeType contains 'document' or mimeType contains 'image'"
                });

                const files = response.result.files;
                if (files && files.length > 0) {
                    displayGoogleDriveFiles(files);
                    showGoogleStatus(`Loaded ${files.length} files from Google Drive.`, 'success');
                } else {
                    showGoogleStatus('No compatible files found in Google Drive.', 'info');
                }
            } catch (error) {
                console.error('Error loading Google Drive files:', error);
                showGoogleStatus('Failed to load files from Google Drive. Please try again.', 'error');
            }
        }

        // Display Google Drive files
        function displayGoogleDriveFiles(files) {
            const fileGrid = document.getElementById('file-grid');
            
            // Remove "no documents" message if present
            const noDocsMessage = fileGrid.querySelector('.text-gray-500');
            if (noDocsMessage && noDocsMessage.textContent.includes('No documents uploaded')) {
                noDocsMessage.remove();
            }
            
            files.forEach(file => {
                const fileElement = document.createElement('div');
                fileElement.className = 'bg-blue-50 border border-blue-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow file-tile';
                fileElement.setAttribute('data-filename', file.name);
                fileElement.setAttribute('draggable', 'true');
                fileElement.addEventListener('dragstart', handleDragStart);
                fileElement.addEventListener('dragend', handleDragEnd);
                
                fileElement.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center text-white font-bold">
                                üìÑ
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">${file.name}</p>
                            <p class="text-xs text-gray-500">From Google Drive</p>
                            <p class="text-xs text-gray-400">Size: ${file.size ? Math.round(file.size/1024) + ' KB' : 'Unknown'}</p>
                        </div>
                    </div>
                    <div class="mt-3 flex justify-center">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            üìÅ Google Drive ‚Ä¢ Drag to match
                        </span>
                    </div>
                `;
                
                fileGrid.appendChild(fileElement);
            });
            
            updateUploadCount();
        }

        // Open Google Drive
        function openGoogleDrive() {
            if (!isSignedIn) {
                showGoogleStatus('Please connect to Google Drive first.', 'error');
                return;
            }
            
            // Open Google Drive in new tab
            window.open('https://drive.google.com', '_blank');
            showGoogleStatus('Google Drive opened in new tab.', 'success');
        }

        // Drag and Drop functionality
        function allowDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function handleDragStart(event) {
            event.target.classList.add('dragging');
            event.dataTransfer.setData('text/plain', event.target.getAttribute('data-filename'));
        }

        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
            // Remove drag-over class from all drop zones
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.classList.remove('drag-over');
            });
        }

        function dropFile(event, checklistItem) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            
            const fileName = event.dataTransfer.getData('text/plain');
            matchFileToChecklist(fileName, checklistItem);
        }

        // File upload handling
        document.addEventListener('DOMContentLoaded', function() {
            const uploadArea = document.getElementById('upload-area');
            const fileInput = document.getElementById('file-input');
            
            // Initialize Google API when page loads
            waitForGapi();
            
            // Set up file upload handling
            if (uploadArea && fileInput) {
                uploadArea.addEventListener('click', () => fileInput.click());
                
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('border-blue-400', 'bg-blue-50');
                });
                
                uploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
                    const files = Array.from(e.dataTransfer.files);
                    handleFiles(files);
                });
                
                fileInput.addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    handleFiles(files);
                });
            }
            
            // Show initial status
            showStatus('‚úÖ Loan Document Manager loaded successfully!', 'success');
        });

        function handleFiles(files) {
            const progressContainer = document.getElementById('upload-progress');
            const progressBar = progressContainer.querySelector('div div');
            
            progressContainer.classList.remove('hidden');
            
            let progress = 0;
            const increment = 100 / files.length;
            
            files.forEach((file, index) => {
                setTimeout(() => {
                    uploadedFiles.push(file);
                    displayFile(file);
                    progress += increment;
                    progressBar.style.width = `${progress}%`;
                    
                    if (index === files.length - 1) {
                        setTimeout(() => {
                            progressContainer.classList.add('hidden');
                            showStatus(`‚úÖ Successfully uploaded ${files.length} file(s)`, 'success');
                            updateUploadCount();
                        }, 500);
                    }
                }, index * 300);
            });
        }

        function displayFile(file) {
            const fileGrid = document.getElementById('file-grid');
            
            // Remove "no documents" message if present
            const noDocsMessage = fileGrid.querySelector('.text-gray-500');
            if (noDocsMessage && noDocsMessage.textContent.includes('No documents uploaded')) {
                noDocsMessage.remove();
            }
            
            const fileElement = document.createElement('div');
            fileElement.className = 'bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow file-tile';
            fileElement.setAttribute('data-filename', file.name);
            fileElement.setAttribute('draggable', 'true');
            fileElement.addEventListener('dragstart', handleDragStart);
            fileElement.addEventListener('dragend', handleDragEnd);
            
            const fileIcon = getFileIcon(file.type);
            const fileSize = (file.size / 1024).toFixed(1);
            
            fileElement.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 bg-gray-500 rounded-lg flex items-center justify-center text-white font-bold">
                            ${fileIcon}
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 truncate">${file.name}</p>
                        <p class="text-xs text-gray-500">Size: ${fileSize} KB</p>
                        <p class="text-xs text-gray-400">Type: ${file.type || 'Unknown'}</p>
                    </div>
                </div>
                <div class="mt-3 flex justify-center">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                        üíª Uploaded ‚Ä¢ Drag to match
                    </span>
                </div>
            `;
            
            fileGrid.appendChild(fileElement);
        }

        function getFileIcon(fileType) {
            if (fileType.includes('pdf')) return 'üìÑ';
            if (fileType.includes('image')) return 'üñºÔ∏è';
            if (fileType.includes('document') || fileType.includes('word')) return 'üìù';
            if (fileType.includes('spreadsheet') || fileType.includes('excel')) return 'üìä';
            return 'üìé';
        }

        function matchFileToChecklist(fileName, checklistItem) {
            const button = document.querySelector(`[data-checklist="${checklistItem}"]`);
            const fileElement = document.querySelector(`[data-filename="${fileName}"]`);
            
            if (!button || !fileElement) {
                showStatus(`‚ùå Could not match ${fileName}`, 'error');
                return;
            }

            // Check if this checklist item is already matched
            if (button.classList.contains('bg-green-500')) {
                showStatus(`‚ö†Ô∏è ${checklistItem} is already matched to another file`, 'warning');
                return;
            }
            
            // Update button appearance
            button.classList.remove('bg-red-500', 'hover:bg-red-600');
            button.classList.add('bg-green-500', 'hover:bg-green-600');
            button.innerHTML = `‚úÖ ${checklistItem}`;
            
            // Store match
            fileMatches[fileName] = checklistItem;
            
            // Move file to matched section
            moveToMatchedSection(fileElement, fileName, checklistItem);
            
            // Update progress
            updateProgress();
            
            showStatus(`‚úÖ Matched: ${fileName} ‚Üí ${checklistItem}`, 'success');
        }

        function moveToMatchedSection(fileElement, fileName, checklistItem) {
            const matchedSection = document.getElementById('matched-files-section');
            const matchedGrid = document.getElementById('matched-files-grid');
            
            // Show matched section
            matchedSection.classList.remove('hidden');
            
            // Create matched file display
            const matchedFileDiv = document.createElement('div');
            matchedFileDiv.className = 'bg-white border border-green-300 rounded-lg p-3 shadow-sm';
            matchedFileDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <span class="text-green-600 font-bold">‚úÖ</span>
                        <div>
                            <p class="text-sm font-medium text-gray-900 truncate">${fileName}</p>
                            <p class="text-xs text-green-600">${checklistItem}</p>
                        </div>
                    </div>
                    <button onclick="unmatchFile('${fileName}', '${checklistItem}')" 
                            class="text-red-500 hover:text-red-700 text-xs">
                        ‚úï
                    </button>
                </div>
            `;
            
            matchedGrid.appendChild(matchedFileDiv);
            
            // Remove from preview
            fileElement.remove();
            
            updateUploadCount();
        }

        function unmatchFile(fileName, checklistItem) {
            // Remove from matches
            delete fileMatches[fileName];
            
            // Update button
            const button = document.querySelector(`[data-checklist="${checklistItem}"]`);
            if (button) {
                button.classList.remove('bg-green-500', 'hover:bg-green-600');
                button.classList.add('bg-red-500', 'hover:bg-red-600');
                button.innerHTML = `‚ùå ${checklistItem}`;
            }
            
            // Remove from matched section
            const matchedGrid = document.getElementById('matched-files-grid');
            const matchedFiles = matchedGrid.querySelectorAll('div');
            matchedFiles.forEach(div => {
                if (div.textContent.includes(fileName)) {
                    div.remove();
                }
            });
            
            // Hide matched section if empty
            if (matchedGrid.children.length === 0) {
                document.getElementById('matched-files-section').classList.add('hidden');
            }
            
            updateProgress();
            showStatus(`‚Ü©Ô∏è Unmatched: ${fileName}`, 'info');
        }

        function updateProgress() {
            const checklistButtons = document.querySelectorAll('[data-checklist]');
            const completedItems = Array.from(checklistButtons).filter(btn => 
                btn.classList.contains('bg-green-500')
            ).length;
            
            const totalItems = checklistButtons.length;
            const percentage = (completedItems / totalItems) * 100;
            
            document.getElementById('progress-bar').style.width = `${percentage}%`;
            document.getElementById('progress-text').textContent = `${completedItems}/${totalItems} items`;
            document.getElementById('matched-count').textContent = completedItems;
        }

        function updateUploadCount() {
            const fileElements = document.querySelectorAll('#file-grid [data-filename]');
            document.getElementById('uploaded-count').textContent = fileElements.length;
        }

        function aiAutoMatch() {
            showStatus('ü§ñ AI analyzing documents...', 'info');
            
            const fileElements = document.querySelectorAll('#file-grid [data-filename]');
            if (fileElements.length === 0) {
                showStatus('‚ùå No files to match. Please upload some documents first.', 'warning');
                return;
            }

            const checklistItems = [
                'Credit Report', 'Income Verification', 'Bank Statements', 
                'Employment Letter', 'Tax Returns', 'Property Appraisal', 
                'Insurance Documents', 'Purchase Agreement'
            ];
            
            let matchCount = 0;
            
            fileElements.forEach((element, index) => {
                setTimeout(() => {
                    const fileName = element.getAttribute('data-filename').toLowerCase();
                    let bestMatch = null;
                    
                    // Enhanced AI matching logic
                    if (fileName.includes('credit') || fileName.includes('score') || fileName.includes('fico')) {
                        bestMatch = 'Credit Report';
                    } else if (fileName.includes('income') || fileName.includes('salary') || fileName.includes('pay') || fileName.includes('w2') || fileName.includes('paystub')) {
                        bestMatch = 'Income Verification';
                    } else if (fileName.includes('bank') || fileName.includes('statement') || fileName.includes('account')) {
                        bestMatch = 'Bank Statements';
                    } else if (fileName.includes('employment') || fileName.includes('job') || fileName.includes('work') || fileName.includes('employer')) {
                        bestMatch = 'Employment Letter';
                    } else if (fileName.includes('tax') || fileName.includes('1040') || fileName.includes('return') || fileName.includes('irs')) {
                        bestMatch = 'Tax Returns';
                    } else if (fileName.includes('appraisal') || fileName.includes('value') || fileName.includes('property') || fileName.includes('home')) {
                        bestMatch = 'Property Appraisal';
                    } else if (fileName.includes('insurance') || fileName.includes('policy') || fileName.includes('coverage')) {
                        bestMatch = 'Insurance Documents';
                    } else if (fileName.includes('purchase') || fileName.includes('agreement') || fileName.includes('contract') || fileName.includes('sale')) {
                        bestMatch = 'Purchase Agreement';
                    } else {
                        // Smart assignment for unmatched files
                        const availableItems = checklistItems.filter(item => {
                            const button = document.querySelector(`[data-checklist="${item}"]`);
                            return button && button.classList.contains('bg-red-500');
                        });
                        if (availableItems.length > 0) {
                            bestMatch = availableItems[0]; // Take first available
                        }
                    }
                    
                    if (bestMatch) {
                        // Check if this item is already matched
                        const button = document.querySelector(`[data-checklist="${bestMatch}"]`);
                        if (button && button.classList.contains('bg-red-500')) {
                            matchFileToChecklist(element.getAttribute('data-filename'), bestMatch);
                            matchCount++;
                        }
                    }
                    
                    // Show completion message
                    if (index === fileElements.length - 1) {
                        setTimeout(() => {
                            showStatus(`üéâ AI matched ${matchCount} documents automatically!`, 'success');
                        }, 500);
                    }
                }, index * 800);
            });
        }

        // Organize and Download - Local file organization
        function organizeAndDownload() {
            if (Object.keys(fileMatches).length === 0) {
                showStatus('No matched files to organize. Please match some documents first.', 'warning');
                return;
            }

            showStatus('üìÅ Organizing files for download...', 'info');

            // Create organized structure
            const organizationData = {
                timestamp: new Date().toLocaleString(),
                totalFiles: Object.keys(fileMatches).length,
                categories: {},
                fileList: []
            };

            // Group files by category
            Object.entries(fileMatches).forEach(([fileName, category]) => {
                if (!organizationData.categories[category]) {
                    organizationData.categories[category] = [];
                }
                organizationData.categories[category].push(fileName);
                organizationData.fileList.push({
                    file: fileName,
                    category: category
                });
            });

            // Generate detailed organization report
            const report = `Solvedet Loan Document Organization Report
Generated: ${organizationData.timestamp}

üìã ORGANIZATION SUMMARY:
‚Ä¢ Total Files Organized: ${organizationData.totalFiles}
‚Ä¢ Categories Used: ${Object.keys(organizationData.categories).length}

üìÇ FILE ORGANIZATION:
${Object.entries(organizationData.categories).map(([category, files]) => `
${category}:
${files.map(file => `  ‚Ä¢ ${file}`).join('\n')}`).join('\n')}

üìä DETAILED FILE LIST:
${organizationData.fileList.map(item => `‚Ä¢ ${item.file} ‚Üí ${item.category}`).join('\n')}

üéØ LOAN APPLICATION STATUS:
${Object.keys(organizationData.categories).length === 8 ? 'COMPLETE - All required documents matched!' : 'PENDING - Some documents still needed'}

üìù FOLDER STRUCTURE RECOMMENDATION:
Create the following folder structure on your computer:

Loan Documents - ${new Date().toLocaleDateString()}/
${Object.keys(organizationData.categories).map(category => `‚îú‚îÄ‚îÄ ${category}/`).join('\n')}

üìß NEXT STEPS:
1. Create the recommended folder structure
2. Move files to their respective categories
3. Review completeness checklist
4. Submit to loan processor

This organization report was generated by Solvedet Loan Document Manager.
For support: creditops@solvedet.com
`;

            // Create and download the organization report
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Loan-Organization-Report-${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            // Create JSON file with organization data
            const jsonBlob = new Blob([JSON.stringify(organizationData, null, 2)], { type: 'application/json' });
            const jsonUrl = URL.createObjectURL(jsonBlob);
            const jsonA = document.createElement('a');
            jsonA.href = jsonUrl;
            jsonA.download = `Loan-Organization-Data-${Date.now()}.json`;
            document.body.appendChild(jsonA);
            jsonA.click();
            document.body.removeChild(jsonA);
            URL.revokeObjectURL(jsonUrl);

            // Show completion message
            const resultDiv = document.getElementById('organization-result');
            resultDiv.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-green-800 mb-4">üéâ Organization Complete!</h3>
                    <div class="space-y-3">
                        <p><strong>üìÅ Files Organized:</strong> ${organizationData.totalFiles} documents</p>
                        <p><strong>üìÇ Categories:</strong> ${Object.keys(organizationData.categories).length} types</p>
                        <p><strong>üìÑ Downloaded:</strong> Organization report & data files</p>
                        <div class="bg-blue-50 border border-blue-200 rounded p-3 mt-4">
                            <p class="text-sm text-blue-800">
                                <strong>üí° Pro Tip:</strong> Once Google verification is approved, 
                                you'll be able to organize files directly in Google Drive!
                            </p>
                        </div>
                    </div>
                </div>
            `;

            showStatus(`‚úÖ Successfully organized ${organizationData.totalFiles} files! Check your downloads.`, 'success');
        }

        function validateDocuments() {
            showStatus('üîç Validating all documents...', 'info');
            
            setTimeout(() => {
                const checklistButtons = document.querySelectorAll('[data-checklist]');
                const completedItems = Array.from(checklistButtons).filter(btn => 
                    btn.classList.contains('bg-green-500')
                ).length;
                const totalItems = checklistButtons.length;
                const completionRate = Math.round((completedItems / totalItems) * 100);
                
                if (completionRate === 100) {
                    showStatus('‚úÖ All documents validated! Loan application is complete.', 'success');
                } else if (completionRate >= 75) {
                    showStatus(`‚ö†Ô∏è Validation: ${completionRate}% complete. Almost ready for submission!`, 'warning');
                } else {
                    showStatus(`‚ùå Validation: ${completionRate}% complete. More documents needed.`, 'error');
                }
            }, 2000);
        }

        function generateReport() {
            showStatus('üìÑ Generating loan compliance report...', 'info');
            
            setTimeout(() => {
                const checklistButtons = document.querySelectorAll('[data-checklist]');
                const completedItems = Array.from(checklistButtons)
                    .filter(btn => btn.classList.contains('bg-green-500'))
                    .map(btn => btn.dataset.checklist);
                
                const missingItems = Array.from(checklistButtons)
                    .filter(btn => btn.classList.contains('bg-red-500'))
                    .map(btn => btn.dataset.checklist);
                
                const report = `Solvedet Loan Document Compliance Report
Generated: ${new Date().toLocaleString()}

LOAN APPLICATION STATUS: ${completedItems.length}/${checklistButtons.length} DOCUMENTS RECEIVED

‚úÖ RECEIVED DOCUMENTS (${completedItems.length}):
${completedItems.map(item => `‚Ä¢ ${item}`).join('\n')}

‚ùå MISSING DOCUMENTS (${missingItems.length}):
${missingItems.map(item => `‚Ä¢ ${item}`).join('\n')}

üìä OVERALL COMPLETION: ${Math.round(completedItems.length/checklistButtons.length*100)}%

STATUS: ${completedItems.length === checklistButtons.length ? 'READY FOR UNDERWRITING' : 'PENDING ADDITIONAL DOCUMENTATION'}

This report was generated by Solvedet Loan Document Manager.
For questions, contact: creditops@solvedet.com
`;
                
                // Create and download the report
                const blob = new Blob([report], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `solvedet-loan-report-${Date.now()}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showStatus('üìÑ Loan compliance report downloaded!', 'success');
            }, 2000);
        }

        function showStatus(message, type = 'info') {
            const statusContainer = document.getElementById('status-messages');
            const statusElement = document.createElement('div');
            
            const colors = {
                success: 'bg-green-100 text-green-800 border-green-200',
                error: 'bg-red-100 text-red-800 border-red-200',
                warning: 'bg-yellow-100 text-yellow-800 border-yellow-200',
                info: 'bg-blue-100 text-blue-800 border-blue-200'
            };
            
            statusElement.className = `p-2 rounded border text-sm ${colors[type] || colors.info}`;
            statusElement.textContent = message;
            
            statusContainer.insertBefore(statusElement, statusContainer.firstChild);
            
            // Remove old messages (keep only last 3)
            while (statusContainer.children.length > 3) {
                statusContainer.removeChild(statusContainer.lastChild);
            }
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (statusElement.parentNode) {
                    statusElement.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
